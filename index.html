<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Nothing Reminder</title>
    <link rel="icon" type="image/png" href="assets/icon.png" />
    <style>
        :root {
          --bg: #ffffff;
          --text: #000000;
          --muted: #666;
          --accent: #4CAF50;
        }
        * { box-sizing: border-box; }
        body {
          margin: 0;
          font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica          Neue", Arial;
          background: var(--bg);
          color: var(--text);
        }
        .sidebar {
          width: 220px;
          background: #666;
          color: #fff;
          position: fixed;
          height: 100%;
          left: 0;
          display: flex;
          flex-direction: column;
          padding: 12px;
          gap: 8px;
          transition: left 0s;
        }
        .profile {
          display:flex;
          align-items:center;
          gap:18px;
          margin-bottom:8px;
        }
        .menu-btn, .icon-btn, .add-btn {
          display:block;
          width:100%;
          padding:10px;
          border: none;
          background:#888;
          font-style: Italic;
          color:#fff;
          border-radius:6px;
          cursor:pointer;
          text-align:left;
          font-size:15px;
          transition: left 0s;
        }
        .menu-btn:hover, .icon-btn:hover, .add-btn:hover { background:#aaa; }
        .main {
          margin-left: 220px;
          padding: 20px;
          min-height: 100vh;
          transition: margin-left 0s;
        }
        .page.hidden { display:none; }
        .toggle-btn {
          position: absolute;
          left: 210px; /* Adjusted to show partial icon */
          top: 12px;
          padding:6px 8px;
          border-radius:8px;
          border:none;
          background:#ddd;
          cursor:pointer;
          transition: left 0s;
          z-index: 10;
          width: 20px; /* Make it smaller to show partial icon */
          height: 20px;
          display: flex;
          align-items: center;
          justify-content: center;
        }
        .list { list-style:none; padding:0; margin:0 0 12px 0; }
        .list li {
          display:flex;
          align-items:center;
          justify-content:space-between;
          padding:8px;
          border-radius:6px;
          margin-bottom:8px;
          background: rgba(0,0,0,0.03);
          transition: left 0s;
        }
        .item-left { display:flex; flex-direction:column; gap:4px; }
        .badge { background:#eee; padding:4px 8px; border-radius:12px;
          font-size:12px; }
        .form {
          margin-top: 0;
          padding: 12px;
          border-radius: 8px;
          background: #f5f5f5;
          display: flex;
          flex-direction: column;
          gap: 8px;
          max-width: 520px;
          overflow: hidden;
          transition: max-height 0s ease, padding 0s ease;
          max-height: 0;
          padding-top: 0;
          padding-bottom: 0;
          transition: left 0s;
        }
        .form.visible {
          max-height: 500px;
          padding-top: 12px;
          padding-bottom: 12px;
        }
        .form label {
          display:flex;
          flex-direction:column;
          font-size:13px;
          gap:6px;
          transition: left 0s;
        }
        .form input[type="text"], .form input[type="date"], .form textarea,          .form select {
          padding:8px;
          border-radius:6px;
          border:1px solid #ccc;
          transition: left 0s;
        }
        .form-actions {
          display:flex;
          gap:8px;
          margin-top:6px;
          transition: left 0s;
        }
        .primary {
          background: var(--accent);
          color: #fff;
          border:none;
          padding:8px 12px;
          border-radius:6px;
          cursor:pointer;
        }
        .secondary {
          background:#ddd;
          border:none;
          padding:8px 12px;
          border-radius:6px;
          cursor:pointer;
        }
        .icon-small {
          background:transparent;
          border:none;
          cursor:pointer;
          margin-left:8px;
          font-size:16px;
        }
        .add-area {
          margin-top: 8px;
          max-width: 520px;
        }
        .dark {
          --bg: #121212;
          --text: #f1f1f1;
        }
        .dark .main { background:#151515; color:var(--text); }
        .dark .form { background: #232323; }
        .dark .menu-btn, .dark .icon-btn { background:#333; color:var(--text);       }

        /* Settings panel styles */
        .settings-panel {
          display: none;
          flex-direction: column;
          gap: 8px;
          margin-top: 8px;
        }
        .settings-panel.visible { display: flex; }

        /* Consistent button styling for all sections */
        #showAddFormBtn, #homeRemindersToggle, #showAddNoteBtn,                      #viewNotesToggle, #homeNotesToggle,
        #homeBudgetsToggle, #homeCheckToggle, #showAddBudgetBtn,                     #viewbudgetToggle, #showAddCheckBtn,
        #viewCheckToggle, #viewRemindersToggle, #monthlyCalendarToggle,              #calculatorToggle, #viewHistoryToggle {
          position: relative;
          user-select: none;
          display: flex;
          justify-content: space-between;
          align-items: center;
          font-weight: 600;
          font-size: 15px;
          cursor: pointer;
          transition: left 0s;
          padding: 10px;
          border: none;
          background: #888;
          color: #fff;
          border-radius: 6px;
          text-align: left;
        }

        #showAddFormBtn:hover, #homeRemindersToggle:hover,                           #showAddNoteBtn:hover, #viewNotesToggle:hover,
        #homeNotesToggle:hover, #homeBudgetsToggle:hover,                            #homeCheckToggle:hover, #showAddBudgetBtn:hover,
        #viewbudgetToggle:hover, #showAddCheckBtn:hover,                             #viewCheckToggle:hover, #viewRemindersToggle:hover {
          background: #aaa;
        }

        #showAddFormBtn.open .arrow, #homeRemindersToggle.open .arrow,               #showAddNoteBtn.open .arrow,
        #viewNotesToggle.open .arrow, #homeNotesToggle.open .arrow,                  #homeBudgetsToggle.open .arrow,
        #homeCheckToggle.open .arrow, #showAddBudgetBtn.open .arrow,                 #viewbudgetToggle.open .arrow,
        #showAddCheckBtn.open .arrow, #viewCheckToggle.open .arrow,                  #viewRemindersToggle.open .arrow {
          transform: rotate(180deg);
          transition: left 0s;
        }

        /* Add this to your existing <style> block */
      .calendar-day {
          padding: 20px 40px;
          border: 10px transparent #eee;
          height: 10px;
          width:  10px;
          display: flex;
          align-items: center;
          justify-content: center;
          cursor: default;
        }
      .calendar-day.today {
          background: var(--accent);
          color: white;
          font-weight: bold;
          border-radius: 600px;
          height: 1px;
          width: 1px;
        }
      .calendar-day.spacer {
          background: transparent;
          border: none;
        }
      .calculator-mode.hidden { display: none; }
      .normal-btn {
          padding: 10px;
          font-size: 16px;
          border: none;
          border-radius: 6px;
          cursor: pointer;
        }
      .normal-btn.primary { background: #e0e0e0; color: #000; }
      .normal-btn.secondary { background: #ccc; color: #000; }

        /* Scrollable lists */
        .scrollable-list {
          max-height: 300px;
          overflow-y: auto;
          border: 1px solid #ccc;
          border-radius: 6px;
          padding: 8px;
          margin-top: 8px;
        }

        /* Scrollbar styling */
        .scrollable-list::-webkit-scrollbar {
          width: 8px;
          border-radius: 4px;
        }

        .scrollable-list::-webkit-scrollbar-track {
          background: #f1f1f1;
          border-radius: 4px;
        }

        .scrollable-list::-webkit-scrollbar-thumb {
          background: #888;
          border-radius: 4px;
        }

        .scrollable-list::-webkit-scrollbar-thumb:hover {
          background: #555;
          border-radius: 4px;
        }

        /* Checklist status button */
        .status-btn {
          background: #007bff;
          color: white;
          border: none;
          padding: 4px 8px;
          border-radius: 4px;
          cursor: pointer;
          margin-right: 8px;
          font-size: 12px;
        }

        /* Branding footer */
        .branding-footer {
          position: fixed;
          bottom: 10px;
          left: 50%;
          transform: translateX(-50%);
          font-size: 12px;
          color: #666;
          text-align: center;
        }

        .branding-footer a {
          color: #666;
          text-decoration: none;
        }

        /* Notification Page Specific Styles */
        .notif-status-box {
          padding: 15px;
          border-radius: 8px;
          margin-bottom: 20px;
          background: #e0f7fa;
          border: 1px solid #b2ebf2;
        }
        .notif-status-box.denied {
          background: #ffebee;
          border: 1px solid #ffcdd2;
        }
        .notif-setting-item {
          display: flex;
          justify-content: space-between;
          align-items: center;
          padding: 10px 0;
          border-bottom: 1px solid #eee;
        }
        .notif-setting-item:last-child {
          border-bottom: none;
        }
        .toggle-switch {
          position: relative;
          display: inline-block;
          width: 50px;
          height: 24px;
        }
        .toggle-switch input {
          opacity: 0;
          width: 0;
          height: 0;
        }
        .slider {
          position: absolute;
          cursor: pointer;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background-color: #ccc;
          transition: 0.4s;
          border-radius: 24px;
        }
        .slider:before {
          position: absolute;
          content: "";
          height: 16px;
          width: 16px;
          left: 4px;
          bottom: 4px;
          background-color: white;
          transition: 0.4s;
          border-radius: 50%;
        }
        input:checked + .slider {
          background-color: var(--accent);
        }
        input:checked + .slider:before {
          transform: translateX(26px);
        }
    </style>
  </head>
  <body>
    <div id="sidebar" class="sidebar">
      <div class="profile">
        <img
          id="profilePhoto"
          src="https://via.placeholder.com/40"
          alt="Profile"
          width="45"
          height="45"
          style="border-radius:50%;object-fit:cover;cursor:pointer;"
          onclick="document.getElementById('photoUpload').click()"
        />
        <h3 id="profileName">üë§ User</h3>
      </div>
      <input
        id="photoUpload"
        type="file"
        accept="image/*"
        style="display:none;"
      />

      <button class="menu-btn" data-page="home">üè† Home</button>
      <button class="menu-btn" data-page="reminders">‚è∞ Reminders</button>
      <button class="menu-btn" data-page="notes">üìù Notes</button>
      <button class="menu-btn" data-page="budget">üí∞ Budget Tracker</button>
      <button class="menu-btn" data-page="Check">‚úí Check List</button>
      <button class="menu-btn" data-page="utilities">üõ†Ô∏è Utilities</button>
      <button class="menu-btn" data-page="other">üé≤ Other Apps</button>

      <div id="settingsContainer" style="margin-top:auto;">
        <button id="settingsBtn" class="icon-btn" aria-expanded="false">
          ‚öôÔ∏è Settings ‚ñº
        </button>
        <div id="settingsPanel" class="settings-panel" aria-hidden="true">
          <button class="menu-btn" id="editNameBtn">‚úèÔ∏è Edit Name</button>
          <button class="icon-btn" id="darkModeBtn">üåô Dark Mode</button>

          <button
            class="menu-btn"
            data-page="notifications"
            id="notificationBtn"
          >
            üîî Notification Settings
          </button>

          <button class="menu-btn" data-page="terms">
            üí¢ Terms & Conditions
          </button>
          <button class="menu-btn" data-page="how">üßë‚Äçüè´ How to Use</button>
        </div>
      </div>
    </div>

    <div id="main" class="main">
      <button id="toggleBtn" class="toggle-btn">‚Æû</button>

      <div id="home" class="page">
        <h2>Home</h2>
        <div class="add-area">
          <button
            id="homeRemindersToggle"
            class="add-btn"
            aria-expanded="false"
          >
            ‚ö†Ô∏è REMINDERS <span class="arrow">‚ñº</span>
          </button>
          <div id="homeRemindersContainer" class="form"></div>
        </div>
        <div class="add-area">
          <button id="homeNotesToggle" class="add-btn" aria-expanded="false">
            üìù NOTES <span class="arrow">‚ñº</span>
          </button>
          <div id="homeNotesContainer" class="form" aria-hidden="true"></div>
        </div>
        <div class="add-area">
          <button id="homeBudgetsToggle" class="add-btn" aria-expanded="false">
            üí∞ BUDGET OVERVIEW <span class="arrow">‚ñº</span>
          </button>
          <div id="homeBudgetsContainer" class="form" aria-hidden="true"></div>
        </div>

        <div class="add-area">
          <button id="homeCheckToggle" class="add-btn" aria-expanded="false">
            ‚úí CHECK LIST <span class="arrow">‚ñº</span>
          </button>
          <div id="homeCheckContainer" class="form" aria-hidden="true"></div>
        </div>

        <div class="branding-footer">
          <a href="https://github.com/spydernet3" target="_blank"
            >By Spydernet</a
          >
        </div>
      </div>

      <div id="reminders" class="page hidden">
        <h2>Reminders</h2>
        <div class="add-area">
          <button id="showAddFormBtn" class="add-btn" aria-expanded="false">
            Ôºã ADD NEW REMINDER <span class="arrow">‚ñº</span>
          </button>
          <div id="reminderFormContainer" class="form" aria-hidden="true">
            <label
              >Title<input id="reminderTitle" type="text" placeholder="Title"
            /></label>
            <label>Start date<input id="startDate" type="date" /></label>
            <label>End date<input id="endDate" type="date" /></label>
            <div class="form-actions">
              <button id="saveReminderBtn" class="primary">Save</button>
              <button id="cancelReminderBtn" class="secondary">Cancel</button>
            </div>
          </div>
        </div>
        <div class="add-area">
          <button
            id="viewRemindersToggle"
            class="add-btn"
            aria-expanded="false"
          >
            üëÄ VIEW REMINDERS <span class="arrow">‚ñº</span>
          </button>
          <ul id="reminderList" class="list scrollable-list form"></ul>
        </div>
      </div>

      <div id="notes" class="page hidden">
        <h2>üìù Notes</h2>
        <div class="add-area">
          <button id="showAddNoteBtn" class="add-btn" aria-expanded="false">
            Ôºã ADD NEW NOTE <span class="arrow">‚ñº</span>
          </button>
          <div id="noteFormContainer" class="form" aria-hidden="true">
            <label>
              Attach File
              <input
                id="noteFile"
                type="file"
                accept="image/*,.pdf,.doc,.docx,.mp3,.mp4"
              />
            </label>

            <label>
              Note<textarea
                id="noteText"
                rows="4"
                placeholder="Write your note here..."
              ></textarea>
            </label>

            <label>
              Table Format<input type="checkbox" id="tableFormatCheckbox" />
              <span>Enable table format</span>
            </label>

            <div class="form-actions">
              <button id="saveNoteBtn" class="primary">Save</button>
              <button id="cancelNoteBtn" class="secondary">Cancel</button>
            </div>
          </div>
        </div>
        <div class="add-area">
          <button id="viewNotesToggle" class="add-btn" aria-expanded="false">
            üëÄ VIEW NOTES <span class="arrow">‚ñº</span>
          </button>
          <ul id="noteList" class="list scrollable-list form"></ul>
        </div>
      </div>

      <div id="budget" class="page hidden">
        <h2>üí∞ Budget Tracker</h2>
        <div class="add-area">
          <button id="showAddBudgetBtn" class="add-btn" aria-expanded="false">
            Ôºã CREATE NEW BUDGET <span class="arrow">‚ñº</span>
          </button>
          <div id="budgetFormContainer" class="form" aria-hidden="true">
            <label
              >Title<input
                id="budgetTitle"
                type="text"
                placeholder="Budget title"
            /></label>
            <label
              >Total Amount (‚Çπ)<input
                id="budgetAmount"
                type="number"
                placeholder="Total Amount"
            /></label>
            <label>Start Date<input id="budgetStartDate" type="date" /></label>
            <label>End Date<input id="budgetEndDate" type="date" /></label>
            <div class="form-actions">
              <button id="saveBudgetBtn" class="primary">Save</button>
              <button id="cancelBudgetBtn" class="secondary">Cancel</button>
            </div>
          </div>
        </div>
        <div class="add-area">
          <button id="viewbudgetToggle" class="add-btn" aria-expanded="false">
            üëÄ VIEW BUDGET OVERVIEW <span class="arrow">‚ñº</span>
          </button>
          <ul id="budgetList" class="list scrollable-list form"></ul>
        </div>
      </div>

      <div id="Check" class="page hidden">
        <h2>‚úí Check List</h2>
        <div class="add-area">
          <button id="showAddCheckBtn" class="add-btn" aria-expanded="false">
            Ôºã CREATE NEW CHECKLIST <span class="arrow">‚ñº</span>
          </button>
          <div id="checkFormContainer" class="form" aria-hidden="true">
            <label>
              Title<input
                id="checkTitle"
                type="text"
                placeholder="Checklist title"
              />
            </label>
            <label>
              Status<select id="checkStatus">
                <option value="open">Open</option>
                <option value="closed">Closed</option>
              </select>
            </label>
            <label>
              Items (one per line)<textarea
                id="checkItems"
                rows="4"
                placeholder="Item 1&#10;Item 2&#10;Item 3"
              ></textarea>
            </label>
            <div class="form-actions">
              <button id="saveCheckBtn" class="primary">Save</button>
              <button id="cancelCheckBtn" class="secondary">Cancel</button>
            </div>
          </div>
        </div>
        <div class="add-area">
          <button id="viewCheckToggle" class="add-btn" aria-expanded="false">
            üëÄ VIEW CHECKLISTS <span class="arrow">‚ñº</span>
          </button>
          <ul id="checkList" class="list scrollable-list form"></ul>
        </div>
      </div>

      <div id="notifications" class="page hidden">
        <h2>üîî Notification Settings</h2>

        <div id="globalNotifStatus" class="notif-status-box">
          <h3>Browser Permission</h3>
          <p id="browserPermissionText"></p>
          <button
            id="requestPermissionBtn"
            class="primary"
            style="margin-top: 10px;"
          >
            Request / Check Permission
          </button>
        </div>

        <h3>Notification Categories</h3>
        <p style="font-size: 14px; opacity: 0.8;">
          Note: Category notifications only work if the browser permission above
          is # Granted #.
        </p>

        <div class="notif-setting-item">
          <span>‚è∞ Reminder Page Reminders</span>
          <label class="toggle-switch">
            <input type="checkbox" id="toggleReminders" />
            <span class="slider"></span>
          </label>
        </div>

        <div class="notif-setting-item">
          <span>üìù Notes Reminders </span>
          <label class="toggle-switch">
            <input type="checkbox" id="toggleNotes" />
            <span class="slider"></span>
          </label>
        </div>

        <div class="notif-setting-item">
          <span>‚úí Checklist Reminders</span>
          <label class="toggle-switch">
            <input type="checkbox" id="toggleChecklist" />
            <span class="slider"></span>
          </label>
        </div>

        <div class="notif-setting-item">
          <span>üí∞ Budget Reminders</span>
          <label class="toggle-switch">
            <input type="checkbox" id="toggleBudget" />
            <span class="slider"></span>
          </label>
        </div>
      </div>

      <div id="terms" class="page hidden">
        <h1>Privacy Policy!</h1>
        <ul>
          <p>
            App data are stored using local storage. Avoid data losses before
            formatting the device.
          </p>
          <p>Maximum 500MB allowed to store user datas in local storage.</p>
          <p>
            Datas are synced as much as possible while page load after it
            depends on your browser behaviour
          </p>
          <p>
            Import & Export and Sharing datas are not allowed for security
            reasons
          </p>
          <p>
            Codes are carefully reviewed by ChatGPT and other AI Models Checkout
            Overall Rating in GitHub Readme file
          </p>
          <p>
            Would you like to contribute, check out here:
            <a href="https://github.com/spydernet3" target="_blank"
              >Spydernet Github ‚Ü†</a
            >
          </p>
        </ul>
        <hr />
        <h3>Version Info!</h3>
        <ul>
          <p>Version 13.4.4</p>
          <p>Last Updated: 19-Sep-2025</p>
          <p>Project Type: Open source</p>
        </ul>
      </div>

      <div id="how" class="page hidden">
        <h3>Reminder!</h3>
        <hr />
        <ul>
          <li>Go to the Reminders page</li>
          <li>Click + Add New Reminder</li>
          <li>Fill Title, Start Date, End Date</li>
          <li>Click Save</li>
          <li>Edit or delete using the ‚úèÔ∏è and üóëÔ∏è button.</li>
          <li>
            Today & Tomorrow Due reminders will appeared on the Home page
            automatically.
          </li>
        </ul>

        <h3>Notes!</h3>
        <hr />
        <ul>
          <li>Go to the Notes page.</li>
          <li>Click + Add New Note.</li>
          <li>Write your note in the textarea.</li>
          <li>It supports file formats (Images, pdf, audio, video, docs).</li>
          <li>Click Save. IST date & time are added automatically.</li>
          <li>Edit or delete using the ‚úèÔ∏è and üóëÔ∏è button.</li>
        </ul>

        <h3>Budget Tracker!</h3>
        <hr />
        <ul>
          <li>Go to the Budget Tracker page.</li>
          <li>Click + Add New Budget.</li>
          <li>That will showed Total Amount/Remaining Days</li>
          <li>That will shows Cost per day How much you need to spend</li>
          <li>
            At Budget reminder it reminders your spend limit hole day with 5
            Mins Interval
          </li>
          <li>Edit or delete using the ‚úèÔ∏è and üóëÔ∏è button.</li>
        </ul>

        <h3>Profile!</h3>
        <hr />
        <ul>
          <li>Click the profile picture to upload a new image.</li>
          <li>Click Edit Name to update the username now under Settings.</li>
        </ul>
        <h3>Checklist!</h3>
        <hr />
        <ul>
          <li>Create checklist and set status either Open/Closed</li>
          <li>Opened checklist listed in Home screen</li>
        </ul>
        <h3>Dark Mode!</h3>
        <hr />
        <ul>
          <li>
            Open Settings (‚öôÔ∏è) in the sidebar, then click the üåô button to
            toggle dark mode.
          </li>
          <li>Dark mode preference is saved.</li>
        </ul>
        <h3>Notification!</h3>
        <hr />
        <ul>
          <li>Notification will showed by default 3 times in a day</li>
          <li>You will Turn Notification On/Off</li>
          <li>Morning 08:00 AM & Afternoon 01:00 PM & Evening 06:00 PM</li>
          <li>You can customize notification as per your requirements</li>
        </ul>
        <h3>Offline Mode</h3>
        <hr />
        <ul>
          <li>
            Step: Download Source Code Zip File in your Device and Extract foder
            then Open index.html without internet in any broweser
          </li>
        </ul>
      </div>

      <div id="utilities" class="page hidden">
        <h2>üõ†Ô∏è Utilities</h2>
        <div class="add-area">
          <button
            id="monthlyCalendarToggle"
            class="add-btn"
            aria-expanded="false"
          >
            üìÖ MONTHLY CALENDAR <span class="arrow">‚ñº</span>
          </button>
          <div id="monthlyCalendarContainer" class="form" aria-hidden="true">
            <div
              id="calendarDisplay"
              style="padding: 10px; border: 1px solid #ddd; border-radius: 6px;"
            >
              <div
                style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;"
              >
                <button id="prevMonthBtn" class="secondary">‚óÄ</button>
                <h4 id="currentMonthYear"></h4>
                <button id="nextMonthBtn" class="secondary">‚ñ∂</button>
              </div>
              <div
                id="calendarGrid"
                style="display: grid; grid-template-columns: repeat(7, 1fr); text-align: center; font-size: 14px;"
              >
                <div>S</div>
                <div>M</div>
                <div>T</div>
                <div>W</div>
                <div>T</div>
                <div>F</div>
                <div>S</div>
              </div>
            </div>
          </div>
        </div>

        <div class="add-area">
          <button id="calculatorToggle" class="add-btn" aria-expanded="false">
            üßÆ CALCULATOR <span class="arrow">‚ñº</span>
          </button>
          <div id="calculatorContainer" class="form" aria-hidden="true">
            <label>
              Select Mode:
              <select id="calculatorMode">
                <option value="normal">Normal Calculator</option>
                <option value="age">Age Calculator</option>
                <option value="date">Date Difference Calculator</option>
                <option value="scientific" disabled>
                  Scientific Calculator (WIP)
                </option>
              </select>
            </label>
            <div id="normalCalculator" class="calculator-mode">
              <input
                type="text"
                id="normalDisplay"
                value="0"
                readonly
                style="text-align: right; font-size: 20px; margin-bottom: 8px;"
              />
              <div
                style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px;"
              >
                <button
                  class="secondary normal-btn"
                  data-value="clear"
                  style="grid-column: span 2;"
                >
                  C
                </button>
                <button class="secondary normal-btn" data-value="backspace">
                  ‚å´
                </button>
                <button class="secondary normal-btn" data-value="/">/</button>

                <button class="primary normal-btn" data-value="7">7</button>
                <button class="primary normal-btn" data-value="8">8</button>
                <button class="primary normal-btn" data-value="9">9</button>
                <button class="secondary normal-btn" data-value="*">*</button>

                <button class="primary normal-btn" data-value="4">4</button>
                <button class="primary normal-btn" data-value="5">5</button>
                <button class="primary normal-btn" data-value="6">6</button>
                <button class="secondary normal-btn" data-value="-">-</button>

                <button class="primary normal-btn" data-value="1">1</button>
                <button class="primary normal-btn" data-value="2">2</button>
                <button class="primary normal-btn" data-value="3">3</button>
                <button class="secondary normal-btn" data-value="+">+</button>

                <button
                  class="primary normal-btn"
                  data-value="."
                  style="font-weight: bold;"
                >
                  .
                </button>
                <button class="primary normal-btn" data-value="0">0</button>
                <button
                  class="primary normal-btn"
                  data-value="equals"
                  style="grid-column: span 2; background: var(--accent);"
                >
                  = Save & Calc
                </button>
              </div>
            </div>
            <div id="ageCalculator" class="calculator-mode hidden">
              <label>Date of Birth <input type="date" id="dobInput" /></label>
              <label>As of Date <input type="date" id="asOfDateInput" /></label>
              <div class="form-actions">
                <button id="calculateAgeBtn" class="primary">
                  Calculate Age
                </button>
              </div>
              <p id="ageResult" style="margin-top: 10px; font-weight: 600;"></p>
            </div>
            <div id="dateCalculator" class="calculator-mode hidden">
              <label>Start Date <input type="date" id="dateDiffStart" /></label>
              <label>End Date <input type="date" id="dateDiffEnd" /></label>
              <div class="form-actions">
                <button id="calculateDateDiffBtn" class="primary">
                  Calculate Difference
                </button>
              </div>
              <p
                id="dateDiffResult"
                style="margin-top: 10px; font-weight: 600;"
              ></p>
            </div>
          </div>
        </div>

        <div class="add-area">
          <button id="viewHistoryToggle" class="add-btn" aria-expanded="false">
            ‚è≥ VIEW HISTORY <span class="arrow">‚ñº</span>
          </button>
          <ul
            id="calculationHistoryList"
            class="list scrollable-list form"
            aria-hidden="true"
          ></ul>
        </div>
      </div>

      <div id="other" class="page hidden">
        <h2>üé≤ Other Apps</h2>
        <div
          style="display: flex; flex-wrap: wrap; gap: 20px; margin-top: 20px;"
        >
          <a
            href="https://you-tube-seven.vercel.app/"
            target="_blank"
            style="text-decoration: none; color: inherit;"
          >
            <button class="menu-btn" style="width: 180px;">
              YouTube Filter
            </button>
          </a>
          <a
            href="https://spydernet3.github.io/QR-Generator/"
            target="_blank"
            style="text-decoration: none; color: inherit;"
          >
            <button class="menu-btn" style="width: 180px;">QR Generator</button>
          </a>
          <a
            href="https://spydernet3.github.io/multi_website_browser/"
            target="_blank"
            style="text-decoration: none; color: inherit;"
          >
            <button class="menu-btn" style="width: 180px;">
              Multi Website Browser
            </button>
          </a>
          <a
            href="https://spydernet3.github.io/Battery_Health_Monitor/"
            target="_blank"
            style="text-decoration: none; color: inherit;"
          >
            <button class="menu-btn" style="width: 180px;">
              Battery Health Monitor
            </button>
          </a>
          <a
            href="https://spydernet3.github.io/farewell/"
            target="_blank"
            style="text-decoration: none; color: inherit;"
          >
            <button class="menu-btn" style="width: 180px;">
              Farewell Wishes
            </button>
          </a>
          <a
            href="https://spydernet3.github.io/live-audio-transcrib/"
            target="_blank"
            style="text-decoration: none; color: inherit;"
          >
            <button class="menu-btn" style="width: 180px;">Email Alert</button>
          </a>
          <a
            href="https://github.com/spydernet3/Text-messaging-alert"
            target="_blank"
            style="text-decoration: none; color: inherit;"
          >
            <button class="menu-btn" style="width: 180px;">SmS Alert</button>
          </a>
          <a
            href="https://spydernet3.github.io/live-audio-transcrib/"
            target="_blank"
            style="text-decoration: none; color: inherit;"
          >
            <button class="menu-btn" style="width: 180px;">
              Live Audio Transcrib
            </button>
          </a>
          <a
            href="https://spydernet3.github.io/Notepad/"
            target="_blank"
            style="text-decoration: none; color: inherit;"
          >
            <button class="menu-btn" style="width: 180px;">Notepad</button>
          </a>
        </div>
      </div>
    </div>

    <script>
            // Service Worker Registration - Fixed to prevent unsupported MIME type error
            if ('serviceWorker' in navigator) {
              window.addEventListener('load', () => {
                // Check for sw.js availability before attempting to register
                fetch('/scripts/sw.js', { method: 'HEAD' })
                  .then(response => {
                    // Only attempt registration if the file exists and is accessible
                    if (response.ok && response.headers.get('content-type').includes('javascript')) {
                      return navigator.serviceWorker.register('/sw.js')
                        .then((registration) => {
                          console.log('SW registered: ', registration);
                        })
                        .catch((error) => {
                          console.log('SW registration failed: ', error);
                        });
                    } else {
                       console.log('SW registration skipped: sw.js file not found or wrong MIME type.');
                    }
                  })
                  .catch(error => {
                    console.log('SW registration failed (network error): ', error);
                  });
              });
            }

            (function () {
              // ---------- Storage ----------

              // Enhanced storage with quota handling
              const STORAGE_KEY = 'smart_reminder_app_v1';

              const defaultData = {
                reminders: [],
                notes: [],
                profileName: '',
                profilePhoto: '',
                darkMode: '0',
                budget: [],
                checklists: [],
                // NEW: Notification preferences
                notifReminders: true,
                notifNotes: true,
                notifChecklist: true,
                notifBudget: true,
                // NEW: Calculation History
                calculationHistory: []
              };

              let appData = JSON.parse(localStorage.getItem(STORAGE_KEY)) || defaultData;
              // Merge with defaults to ensure new notif keys are present on load
              appData = { ...defaultData, ...appData };
              // Ensure new property is initialized if old data exists
              if (!appData.calculationHistory) appData.calculationHistory = [];


              let editingIndex = null;
              let editingBudgetIndex = null;
              let editingCheckIndex = null;
              let editingNoteIndex = null;
              let editingHistoryIndex = null; // NEW: for history editing

              let currentMonth = new Date().getMonth(); // NEW: Calendar state
              let currentYear = new Date().getFullYear(); // NEW: Calendar state
              // ... rest of the script ...


              // ---------- Helpers ----------
              function byId(id){ return document.getElementById(id); }

              // Modified save function to use localStorage only
              async function saveAll() {
                try {
                  const dataStr = JSON.stringify(appData);
                  localStorage.setItem(STORAGE_KEY, dataStr);
                  console.log("Data saved successfully to localStorage.");
                  // Re-render the notification page whenever data changes
                  renderNotificationPage();
                } catch (err) {
                  console.error("Save failed:", err);
                  if (err.name === 'QuotaExceededError') {
                    console.error("Storage is full. Please delete some data to make space.");
                  }
                }
              }

              function daysLeft(endDateStr){
                if(!endDateStr) return null;
                const [y,m,d] = endDateStr.split('-').map(Number);
                const end = new Date(y,m-1,d);
                const now = new Date();
                const diffTime = end.setHours(0,0,0,0) - now.setHours(0,0,0,0);
                return Math.floor(diffTime / (1000*60*60*24));
              }

              function formatDMY(dateStr){
                if(!dateStr) return '';
                const [y,m,d] = dateStr.split('-');
                return `${d.toString().padStart(2,'0')}/${m.toString().padStart(2,'0')}/${y}`;
              }

              // Format date as DD-MMM-YYYY with IST time (12-hour format)
              function formatDateDMYWithTime(date) {
                const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun',
                               'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                const day = date.getDate().toString().padStart(2, '0');
                const month = months[date.getMonth()];
                const year = date.getFullYear();

                // Get IST time (UTC+5:30)
                const istHours = date.getHours();
                const istMinutes = date.getMinutes().toString().padStart(2, '0');
                const ampm = istHours >= 12 ? 'PM' : 'AM';
                const displayHours = istHours % 12 || 12;

                return `${day}-${month}-${year} ${displayHours}:${istMinutes} ${ampm}`;
              }

              // Calculate days between two dates
              function daysBetween(startDateStr, endDateStr) {
                if (!startDateStr || !endDateStr) return 0;
                const [startY, startM, startD] = startDateStr.split('-').map(Number);
                const [endY, endM, endD] = endDateStr.split('-').map(Number);
                const start = new Date(startY, startM-1, startD);
                const end = new Date(endY, endM-1, endD);
                const diffTime = end.setHours(0,0,0,0) - start.setHours(0,0,0,0);
                return Math.floor(diffTime / (1000*60*60*24)) + 1; // +1 to include both start and end dates
              }

              // Calculate cost per day
              function calculateCostPerDay(amount, startDate, endDate) {
                const days = daysBetween(startDate, endDate);
                if (days <= 0 || amount <= 0) return 0;
                return (amount / days).toFixed(2);
              }

              function renderReminders(){
                const list = byId('reminderList'); list.innerHTML = '';
                  if(appData.reminders.length === 0){
                  const li = document.createElement('li'); li.textContent='No reminders yet.'; li.style.opacity='0.7'; list.appendChild(li);
                  renderHomeReminders(); renderHomeNotes(); renderHomeCheck(); return;
                }
                const frag = document.createDocumentFragment();
                appData.reminders.forEach((r,i)=>{
                  const li=document.createElement('li');
                  const left=document.createElement('div'); left.className='item-left';
                  const title=document.createElement('div'); title.textContent=r.title; title.style.fontWeight='600';
                  const dates=document.createElement('div'); dates.style.fontSize='13px'; dates.style.opacity='0.85'; dates.textContent=`Start: ${formatDMY(r.startDate)} | End: ${formatDMY(r.endDate)}`;
                  left.appendChild(title); left.appendChild(dates);

                  const right=document.createElement('div'); right.style.display='flex'; right.style.alignItems='center';
                  const badge=document.createElement('div'); badge.className='badge';
                  const diff = daysLeft(r.endDate);
                  if(diff === null){ badge.textContent='No date'; }
                  else if(diff < 0){ badge.textContent='Expired'; }
                  else if(diff === 0){ badge.textContent='Today'; }
                  else{ badge.textContent=`${diff} days left`; }

                  const editBtn=document.createElement('button'); editBtn.className='icon-small'; editBtn.textContent='‚úèÔ∏è'; editBtn.title='Edit'; editBtn.addEventListener('click',()=>editReminder(i));
                  const delBtn=document.createElement('button'); delBtn.className='icon-small'; delBtn.textContent='üóëÔ∏è'; delBtn.title='Delete'; delBtn.addEventListener('click',()=>deleteReminder(i));

                  right.appendChild(badge);
                  right.appendChild(editBtn);
                  right.appendChild(delBtn);
                  li.appendChild(left); li.appendChild(right); frag.appendChild(li);
                });
                list.appendChild(frag);
                renderHomeReminders(); renderHomeNotes(); renderHomeCheck();
              }

              function renderHomeReminders(){
                const container = byId('homeRemindersContainer');
                container.innerHTML='';
                // Filter reminders to show only today and 1 day left
                const filteredReminders = appData.reminders.filter(r => {
                  const diff = daysLeft(r.endDate);
                  return diff === 0 || diff === 1;
                });

                if(filteredReminders.length === 0){
                  const li=document.createElement('li');
                  li.textContent='No reminders for today or tomorrow.';
                  li.style.opacity='0.7';
                  container.appendChild(li);
                  return;
                }

                const frag=document.createDocumentFragment();
                filteredReminders.forEach(r=>{
                  const li=document.createElement('li');
                  const diff = daysLeft(r.endDate);
                  let badgeText='';
                  if(diff === null){ badgeText='No date'; }
                  else if(diff < 0){ badgeText='Expired'; }
                  else if(diff === 0){ badgeText='Today'; }
                  else{ badgeText=`${diff} days left`; }
                  li.textContent = `\"${r.title}\" || ${badgeText}`;
                  frag.appendChild(li);
                });
                container.appendChild(frag);
              }

              // Update renderHomeNotes function to handle table formatting
              function renderHomeNotes(){
                const container = byId('homeNotesContainer');
                container.innerHTML = '';

                if(appData.notes.length === 0){
                  const li = document.createElement('li');
                  li.textContent = 'No notes available.';
                  li.style.opacity = '0.7';
                  container.appendChild(li);
                  return;
                }

                const frag = document.createDocumentFragment();

                appData.notes.forEach(n => {
                  const li = document.createElement('li');
                  li.className = 'list-item';

                  const left = document.createElement('div');
                  left.className = 'item-left';

                  // Main Text/Table Content
                  const text = document.createElement('div');
                  if(n.isTable && n.text) {
                    // Show first few rows of table in home view
                    const lines = n.text.split('\n');
                    let tableHTML = '<table border=\"1\" style=\"border-collapse: collapse; width: 100%;\">';

                    lines.forEach((line, index) => {
                      if(line.includes('---')) {
                        if(index > 0) tableHTML += '</tr>';
                        tableHTML += '<tr>';
                      } else if(line.includes('|')) {
                        const cells = line.split('|').filter(cell => cell.trim() !== '');
                        cells.forEach(cell => {
                          const cellContent = cell.trim();
                          if(index === 0) {
                            tableHTML += `<th style=\"border: 1px solid #ddd; padding: 4px;\">${cellContent}</th>`;
                          } else {
                            tableHTML += `<td style=\"border: 1px solid #ddd; padding: 4px;\">${cellContent}</td>`;
                          }
                        });
                      }
                    });

                    tableHTML += '</tr></table>';
                    text.innerHTML = tableHTML;
                  } else {
                    text.innerHTML = `<b>${(n.text || '').substring(0, 50)}...</b><br><small style=\"opacity:0.7\">${n.createdAt || ''}</small>`;
                  }
                  left.appendChild(text);

                  // File Thumbnail Display - EXISTING, KEPT
                  if (n.file && n.file.type && n.file.type.includes('image')) {
                    const thumb = document.createElement('img');
                    thumb.src = n.file.data;
                    thumb.style.maxWidth = '40px';
                    thumb.style.marginLeft = '5px';
                    thumb.style.borderRadius = '4px';
                    thumb.style.verticalAlign = 'middle';
                    thumb.alt = n.file.name || 'image';
                    left.appendChild(thumb);
                  }

                  li.appendChild(left);
                  frag.appendChild(li);
                });

                container.appendChild(frag);
              }

              // Update renderNotes function to handle table formatting
              function renderNotes(){
                const list = byId('noteList'); list.innerHTML='';
                if(appData.notes.length===0){
                  const li=document.createElement('li');
                  li.textContent='No notes yet.'; li.style.opacity='0.7';
                  list.appendChild(li);
                  return;
                }
                const frag=document.createDocumentFragment();
                appData.notes.forEach((note,i)=>{
                  const li=document.createElement('li');
                  const left=document.createElement('div'); left.className='item-left';

                  const text=document.createElement('div');
                  if(note.isTable && note.text) {
                    // Convert table format to HTML table
                    const lines = note.text.split('\n');
                    let tableHTML = '<table border=\"1\" style=\"border-collapse: collapse; width: 100%;\">';

                    lines.forEach((line, index) => {
                      if(line.includes('---')) {
                        // Row separator - add closing tags for previous row
                        if(index > 0) tableHTML += '</tr>';
                        tableHTML += '<tr>';
                      } else if(line.includes('|')) {
                        // Table row
                        const cells = line.split('|').filter(cell => cell.trim() !== '');
                        cells.forEach(cell => {
                          const cellContent = cell.trim();
                          if(index === 0) {
                            tableHTML += `<th style=\"border: 1px solid #ddd; padding: 8px;\">${cellContent}</th>`;
                          } else {
                            tableHTML += `<td style=\"border: 1px solid #ddd; padding: 8px;\">${cellContent}</td>`;
                          }
                        });
                      }
                    });

                    tableHTML += '</tr></table>';
                    text.innerHTML = tableHTML;
                  } else {
                    text.innerHTML=`<b>${note.text||''}</b><br>
                      <small style=\"opacity:0.7\">${note.createdAt||''}</small>`;
                  }
                  left.appendChild(text);

                  // --- file rendering - EXISTING, KEPT ---
                  if(note.file){
                    let fileEl;

                    // üì∑ --- Image Support ---
                    if(note.file.type.includes('image')){
                      fileEl=document.createElement('img');
                      fileEl.src=note.file.data;
                      fileEl.style.maxWidth='200px';
                      fileEl.style.display='block';
                      fileEl.style.marginTop='5px';
                    }
                    // üéµ --- Audio Support ---
                    else if(note.file.type.includes('audio')){
                      fileEl=document.createElement('audio');
                      fileEl.controls=true;
                      fileEl.src=note.file.data;
                    }
                    // üé¨ --- Video Support ---
                    else if(note.file.type.includes('video')){
                      fileEl=document.createElement('video');
                      fileEl.controls=true;
                      fileEl.width=200;
                      fileEl.src=note.file.data;
                    }
                    // üìÑ --- Docs (PDF/DOC) ---
                    else {
                      fileEl=document.createElement('a');
                      fileEl.href=note.file.data;
                      fileEl.download=note.file.name;
                      fileEl.textContent='üìé '+note.file.name;
                    }

                    left.appendChild(fileEl);
                  }

                  const right = document.createElement('div');
                  right.style.display = 'flex';
                  right.style.alignItems = 'center';

                  const editBtn = document.createElement('button');
                  editBtn.className = 'icon-small';
                  editBtn.textContent = '‚úèÔ∏è';
                  editBtn.title = 'Edit';
                  editBtn.addEventListener('click', () => editNote(i));

                  const delBtn=document.createElement('button');
                  delBtn.className='icon-small'; delBtn.textContent='üóëÔ∏è';
                  delBtn.title='Delete';
                  delBtn.addEventListener('click',()=>{ deleteNote(i); });

                  right.appendChild(editBtn);
                  right.appendChild(delBtn);
                  li.appendChild(left); li.appendChild(right); frag.appendChild(li);
                });
                list.appendChild(frag);
              }

              // ---------- Budget Functions ----------
              function renderBudgets(){
                const list = byId('budgetList'); list.innerHTML = '';
                // Ensure appData.budget exists and is an array
                if (!appData.budget || !Array.isArray(appData.budget)) {
                  appData.budget = [];
                }
                if(appData.budget.length === 0){
                  const li = document.createElement('li'); li.textContent='No budgets yet.'; li.style.opacity='0.7'; list.appendChild(li);
                  renderHomeBudgets(); return;
                }
                const frag = document.createDocumentFragment();
                appData.budget.forEach((b,i)=>{
                  const li=document.createElement('li');
                  const left=document.createElement('div'); left.className='item-left';

                  // Calculate cost per day
                  const costPerDay = calculateCostPerDay(b.amount, b.startDate, b.endDate);
                  const days = daysBetween(b.startDate, b.endDate);

                  const title=document.createElement('div');
                  title.textContent=`Title: ${b.title}`;
                  title.style.fontWeight='600';

                  const amounts=document.createElement('div');
                  amounts.style.fontSize='13px';
                  amounts.style.opacity='0.85';
                  amounts.textContent=`Total Budget: ‚Çπ${b.amount} | Remaining Days: ${days} | Cost per Day: ‚Çπ${costPerDay}`;

                  left.appendChild(title); left.appendChild(amounts);

                  const right=document.createElement('div'); right.style.display='flex'; right.style.alignItems='center';
                  const editBtn=document.createElement('button'); editBtn.className='icon-small'; editBtn.textContent='‚úèÔ∏è'; editBtn.title='Edit'; editBtn.addEventListener('click',()=>editBudget(i));
                  const delBtn=document.createElement('button'); delBtn.className='icon-small'; delBtn.textContent='üóëÔ∏è'; delBtn.title='Delete'; delBtn.addEventListener('click',()=>deleteBudget(i));

                  right.appendChild(editBtn); right.appendChild(delBtn);
                  li.appendChild(left); li.appendChild(right); frag.appendChild(li);
                });
                list.appendChild(frag);
                renderHomeBudgets();
              }

              function renderHomeBudgets(){
                const container = byId('homeBudgetsContainer');
                container.innerHTML='';
                // Ensure appData.budget exists and is an array
                if (!appData.budget || !Array.isArray(appData.budget)) {
                  appData.budget = [];
                }
                if(appData.budget.length === 0){
                  const li=document.createElement('li');
                  li.textContent='No budgets yet.';
                  li.style.opacity='0.7';
                  container.appendChild(li);
                  return;
                }
                const frag=document.createDocumentFragment();
                appData.budget.forEach(b=>{
                  // Calculate cost per day
                  const costPerDay = calculateCostPerDay(b.amount, b.startDate, b.endDate);
                  const days = daysBetween(b.startDate, b.endDate);

                  const li=document.createElement('li');
                  li.textContent = `\"${b.title}\" || Total: ‚Çπ${b.amount} || Remaining: ${days} days || Cost: ‚Çπ${costPerDay}/day`;
                  frag.appendChild(li);
                });
                container.appendChild(frag);
              }

              function editBudget(i){
                const b=appData.budget[i];
                editingBudgetIndex=i;
                byId('budgetTitle').value=b.title;
                byId('budgetAmount').value=b.amount;
                byId('budgetStartDate').value=b.startDate||'';
                byId('budgetEndDate').value=b.endDate||'';
                showForm(byId('budgetFormContainer'));
              }

              function deleteBudget(index){
                appData.budget.splice(index, 1);
                saveAll();
                renderBudgets();
                renderHomeBudgets();
              }

              function saveBudget(){
                const title=byId('budgetTitle').value.trim();
                const amount=byId('budgetAmount').value;
                const start=byId('budgetStartDate').value;
                const end=byId('budgetEndDate').value;
                if(!title || !amount){ alert('Title and amount are required to save a budget.'); return; }
                const budgetObj={ title, amount, startDate:start, endDate:end };
                if(editingBudgetIndex!==null){ appData.budget[editingBudgetIndex]=budgetObj; editingBudgetIndex=null; }
                else{ appData.budget.push(budgetObj); }
                saveAll(); renderBudgets(); hideForm(byId('budgetFormContainer')); clearBudgetForm();
              }

              function clearBudgetForm(){
                byId('budgetTitle').value='';
                byId('budgetAmount').value='';
                byId('budgetStartDate').value='';
                byId('budgetEndDate').value='';
              }

              function editReminder(i){
                const r=appData.reminders[i];
                editingIndex=i;
                byId('reminderTitle').value=r.title;
                byId('startDate').value=r.startDate||'';
                byId('endDate').value=r.endDate||'';
                showForm(byId('reminderFormContainer'));
              }

              function deleteReminder(index){
                appData.reminders.splice(index, 1);
                saveAll();
                renderReminders();
                renderHomeReminders();
              }

              function saveReminder(){
                const title=byId('reminderTitle').value.trim();
                const start=byId('startDate').value;
                const end=byId('endDate').value;
                if(!title){ alert('Title is required for the reminder.'); return; }
                const reminderObj={ title, startDate:start, endDate:end };
                if(editingIndex!==null){ appData.reminders[editingIndex]=reminderObj; editingIndex=null; }
                else{ appData.reminders.push(reminderObj); }
                saveAll(); renderReminders(); hideForm(byId('reminderFormContainer')); clearReminderForm();
              }

              function clearReminderForm(){
                byId('reminderTitle').value='';
                byId('startDate').value='';
                byId('endDate').value='';
              }

              function deleteNote(index){
                appData.notes.splice(index,1);
                saveAll();
                renderNotes();
                renderHomeNotes();
              }

              // Updated editNote (removed AI-related code)
              function editNote(index){
                const note = appData.notes[index];
                editingNoteIndex = index;

                byId('noteText').value = note.text || '';
                byId('tableFormatCheckbox').checked = note.isTable || false;

                // Show the form
                showForm(byId('noteFormContainer'));

                // Set the save button to update instead of create
                byId('saveNoteBtn').textContent = 'Update';
              }

              // Updated saveNote (removed AI-related code)
              function saveNote(){
                const text = byId('noteText').value.trim();
                const fileInput = byId('noteFile');
                const file = fileInput.files[0];
                const isTableFormat = byId('tableFormatCheckbox').checked;

                if(!text && !file){
                  alert('Note cannot be empty. Please add text or a file.');
                  return;
                }

                // Format date for all notes
                const noteDate = formatDateDMYWithTime(new Date());

                let noteText = text;
                if (isTableFormat && text) {
                  // Add date/time to the beginning of the table
                  noteText = `Created: ${noteDate}\n\n${text}`;
                }

                const noteObj = {
                  text: noteText,
                  createdAt: noteDate,
                  file: null,
                  isTable: isTableFormat,
                  // Removed: aiSummary: temporaryAISummary
                };

                const finalizeSave = (noteObj) => {
                    if(editingNoteIndex !== null){
                        appData.notes[editingNoteIndex] = noteObj;
                        editingNoteIndex = null;
                    } else {
                        appData.notes.push(noteObj);
                    }
                    saveAll(); renderNotes(); renderHomeNotes();
                    hideForm(byId('noteFormContainer'));
                    byId('noteText').value='';
                    fileInput.value='';
                    byId('tableFormatCheckbox').checked = false;
                    byId('saveNoteBtn').textContent = 'Save';
                }

                if(file){
                  const reader = new FileReader();
                  reader.onload = function(e){
                    noteObj.file = {
                      name: file.name,
                      type: file.type,
                      data: e.target.result
                    };
                    finalizeSave(noteObj);
                  };
                  reader.onerror = function() {
                    console.error('Error reading file. Please try again.');
                    fileInput.value = '';
                  };
                  reader.readAsDataURL(file);
                } else {
                  finalizeSave(noteObj);
                }
              }

              function deleteCheck(index){
                appData.checklists.splice(index,1);
                saveAll();
                renderChecklists();
                renderHomeCheck();
              }

              function editCheck(index){
                const check = appData.checklists[index];
                editingCheckIndex = index;

                byId('checkTitle').value = check.title || '';
                byId('checkStatus').value = check.status || 'open';
                byId('checkItems').value = check.items ? check.items.join('\n') : '';

                // Show the form
                showForm(byId('checkFormContainer'));

                // Set the save button to update instead of create
                byId('saveCheckBtn').textContent = 'Update';
              }

              function toggleCheckStatus(index) {
                const check = appData.checklists[index];
                check.status = check.status === 'open' ? 'closed' : 'open';
                saveAll();
                renderChecklists();
                renderHomeCheck();
              }

              function saveCheck(){
                const title = byId('checkTitle').value.trim();
                const status = byId('checkStatus').value;
                const itemsText = byId('checkItems').value.trim();
                const items = itemsText ? itemsText.split('\n').filter(item => item.trim() !== '') : [];

                if(!title){
                  alert('Title is required for the checklist.');
                  return;
                }

                const checkObj = {
                  title,
                  items,
                  status: status,
                  createdAt: formatDateDMYWithTime(new Date()) // Use DD-MMM-YYYY with IST time format
                };

                if(editingCheckIndex !== null){
                  appData.checklists[editingCheckIndex] = checkObj;
                  editingCheckIndex = null;
                } else {
                  appData.checklists.push(checkObj);
                }

                saveAll();
                renderChecklists();
                renderHomeCheck();

                hideForm(byId('checkFormContainer'));
                byId('checkTitle').value = '';
                byId('checkStatus').value = 'open';
                byId('checkItems').value = '';
                byId('saveCheckBtn').textContent = 'Save';
              }


              function renderHomeCheck(){
                const container = byId('homeCheckContainer');
                container.innerHTML = '';

                // Ensure appData.checklists exists and is an array
                if (!appData.checklists || !Array.isArray(appData.checklists)) {
                  appData.checklists = [];
                }

                if(appData.checklists.length === 0){
                  const li = document.createElement('li');
                  li.textContent = 'No checklists yet.';
                  li.style.opacity = '0.7';
                  container.appendChild(li);
                  return;
                }

                const frag = document.createDocumentFragment();

                appData.checklists.forEach(check => {
                  if(check.status === 'open') {
                    const li = document.createElement('li');
                    li.textContent = `\"${check.title}\" - ${check.items.length} items`;
                    frag.appendChild(li);
                  }
                });

                container.appendChild(frag);
              }

              function renderChecklists(){
                const list = byId('checkList'); list.innerHTML = '';
                // Ensure appData.checklists exists and is an array
                if (!appData.checklists || !Array.isArray(appData.checklists)) {
                  appData.checklists = [];
                }
                if(appData.checklists.length === 0){
                  const li = document.createElement('li'); li.textContent='No checklists yet.'; li.style.opacity='0.7'; list.appendChild(li);
                  renderHomeCheck(); return;
                }
                const frag = document.createDocumentFragment();
                appData.checklists.forEach((check,i)=>{
                  const li=document.createElement('li');
                  const left=document.createElement('div'); left.className='item-left';

                  const title=document.createElement('div');
                  title.textContent=`${check.title}`;
                  title.style.fontWeight='600';

                  // START OF MODIFICATION: Display checklist items
                  const itemsPreview=document.createElement('div');
                  itemsPreview.style.fontSize='13px';
                  itemsPreview.style.opacity='0.9';

                  // Get the first 3 items or all items if less than 3
                  const previewItems = check.items.slice(0, 3);
                  let itemsText = previewItems.map(item => `\u2022 ${item}`).join('<br>'); // \u2022 is a bullet point

                  // Add an ellipsis if there are more than 3 items
                  if(check.items.length > 3) {
                      itemsText += '<br>... and ' + (check.items.length - 3) + ' more items';
                  } else if (check.items.length === 0) {
                      itemsText = 'No items in list.';
                  }

                  itemsPreview.innerHTML = itemsText;
                  // END OF MODIFICATION

                  const statusInfo=document.createElement('div');
                  statusInfo.style.fontSize='13px';
                  statusInfo.style.opacity='0.85';
                  statusInfo.textContent=`Status: ${check.status} | Total Items: ${check.items.length}`;

                  const time=document.createElement('div');
                  time.style.fontSize='12px';
                  time.style.opacity='0.7';
                  time.textContent=check.createdAt || '';

                  left.appendChild(title);
                  left.appendChild(itemsPreview); // Added the item preview
                  left.appendChild(statusInfo);
                  left.appendChild(time);

                  const right = document.createElement('div');
                  right.style.display = 'flex';
                  right.style.alignItems = 'center';

                  // Add status button
                  const statusBtn = document.createElement('button');
                  statusBtn.className = 'status-btn';
                  statusBtn.textContent = check.status === 'open' ? 'Open' : 'Closed';
                  statusBtn.title = 'Change Status';
                  statusBtn.addEventListener('click', () => toggleCheckStatus(i));

                  const editBtn = document.createElement('button');
                  editBtn.className = 'icon-small';
                  editBtn.textContent = '‚úèÔ∏è';
                  editBtn.title = 'Edit';
                  editBtn.addEventListener('click', () => editCheck(i));

                  const delBtn=document.createElement('button');
                  delBtn.className='icon-small'; delBtn.textContent='üóëÔ∏è';
                  delBtn.title='Delete';
                  delBtn.addEventListener('click',()=>{ deleteCheck(i); });

                  right.appendChild(statusBtn);
                  right.appendChild(editBtn);
                  right.appendChild(delBtn);
                  li.appendChild(left); li.appendChild(right); frag.appendChild(li);
                });
                list.appendChild(frag);
                renderHomeCheck();
              }

              // ---------- Form Show/Hide ----------
              function showForm(el){ el.classList.add('visible'); }
              function hideForm(el){ el.classList.remove('visible'); }

              // ---------- Page Navigation ----------
              const sidebar = byId('sidebar');
              const main = byId('main');
              const toggleBtn = byId('toggleBtn');

              function showPage(pageId){
                document.querySelectorAll('.page').forEach(p=>p.classList.add('hidden'));
                const targetPage = byId(pageId);
                targetPage.classList.remove('hidden');

                // Special handling for the notifications page
                if (pageId === 'notifications') {
                  renderNotificationPage();
                }

                // Auto-hide sidebar instantly when an option is chosen
                sidebar.style.left = '-220px';
                main.style.marginLeft = '0';
                toggleBtn.textContent = '‚Æû';
                sidebar.style.transition = 'left 0s';   // instant hide
                main.style.transition = 'margin-left 0s'; // instant hide
              }

              // ---------- Sidebar Toggle ----------
              toggleBtn.addEventListener('click', function() {
                if (sidebar.style.left === '-220px' || sidebar.style.left === '') {
                  sidebar.style.left = '0px';
                  main.style.marginLeft = '220px';
                  toggleBtn.textContent = '‚Æú';
                } else {
                  sidebar.style.left = '-220px';
                  main.style.marginLeft = '0';
                  toggleBtn.textContent = '‚Æû';
                }
              });

              // ---------- Settings Panel (new) ----------
              const settingsBtn = byId('settingsBtn');
              const settingsPanel = byId('settingsPanel');
              if(settingsBtn && settingsPanel){
                settingsBtn.addEventListener('click', ()=>{
                  const opened = settingsPanel.classList.toggle('visible');
                  settingsBtn.setAttribute('aria-expanded', opened);
                  settingsPanel.setAttribute('aria-hidden', !opened);
                });
              }

              // ---------- Dark Mode ----------
              const darkBtn=byId('darkModeBtn');
              darkBtn.addEventListener('click',()=>{
                document.body.classList.toggle('dark');
                appData.darkMode=document.body.classList.contains('dark')?'1':'0';
                saveAll();
              });

              // ---------- Profile ----------
              const profileNameEl=byId('profileName');
              byId('editNameBtn').addEventListener('click',()=>{
                const n=prompt('Enter new name:',appData.profileName||'');
                if(n){
                  appData.profileName=n;
                  profileNameEl.textContent=n;
                  saveAll();
                }
              });

              const profilePhotoInput=byId('photoUpload');
              profilePhotoInput.addEventListener('change',(e)=>{
                const file=e.target.files[0];
                if(file){
                  const reader=new FileReader();
                  reader.onload=function(ev){
                    appData.profilePhoto=ev.target.result;
                    byId('profilePhoto').src=ev.target.result;
                    saveAll();
                  };
                  reader.readAsDataURL(file);
                }
              });

              // ---------- NEW: Notification Settings Logic ----------
              function updateBrowserPermissionUI() {
                  const status = Notification.permission;
                  const textEl = byId('browserPermissionText');
                  const boxEl = byId('globalNotifStatus');
                  const btnEl = byId('requestPermissionBtn');

                  boxEl.classList.remove('denied');

                  if (status === 'granted') {
                      textEl.innerHTML = 'Status: <b style="color: var(--accent);">Granted (ON)</b>';
                      btnEl.textContent = 'Permission Granted';
                      btnEl.disabled = true;
                  } else if (status === 'denied') {
                      textEl.innerHTML = 'Status: <b style="color: #f44336;">Denied (OFF)</b>. Please change in browser settings.';
                      btnEl.textContent = 'Permission Denied';
                      btnEl.disabled = true;
                      boxEl.classList.add('denied');
                  } else { // 'default' or not supported
                      textEl.innerHTML = 'Status: <b style="color: #ff9800;">Not Requested (OFF)</b>';
                      btnEl.textContent = 'Request Permission';
                      btnEl.disabled = false;
                  }
              }

              function requestNotificationPermission() {
                if (!("Notification" in window)) {
                    console.error("This browser does not support desktop notification");
                    return;
                }
                if (Notification.permission === 'granted' || Notification.permission === 'denied') {
                   updateBrowserPermissionUI();
                   return;
                }

                Notification.requestPermission().then(function(permission) {
                    updateBrowserPermissionUI();
                });
              }

              function renderNotificationPage() {
                  if (!("Notification" in window)) {
                      byId('globalNotifStatus').innerHTML = '<h3>Browser Permission</h3><p style="color: #f44336;">Notifications are not supported by your browser.</p>';
                      return;
                  }

                  updateBrowserPermissionUI();

                  // Setup custom category toggles based on appData
                  byId('toggleReminders').checked = appData.notifReminders;
                  byId('toggleNotes').checked = appData.notifNotes;
                  byId('toggleChecklist').checked = appData.notifChecklist;
                  byId('toggleBudget').checked = appData.notifBudget;
              }

              // Function to handle custom toggle changes
              function handleCustomNotifToggle(category, event) {
                  appData[category] = event.target.checked;
                  saveAll();
                  // Re-check notifications immediately if a new category is toggled on
                  if (event.target.checked) checkNotifications();
              }


              // ---------- Notifications Logic (Updated for comprehensive summary) ----------

              // Helper 1: Reminders (Today or Tomorrow)
              function buildReminderSummary() {
                  let summary = [];
                  appData.reminders.forEach(r => {
                      const diff = daysLeft(r.endDate);
                      if (diff === 0 || diff === 1) { // Only Today or Tomorrow as per home screen
                          summary.push(`- ${r.title} | ${diff === 0 ? 'Today' : 'Tomorrow'}`);
                      }
                  });
                  return summary.length > 0 ? summary.join('\n') : "No reminders due today/tomorrow.";
              }

              // Helper 2: Checklist (Open status)
              function buildChecklistSummary() {
                  let summary = [];
                  const openChecks = appData.checklists.filter(c => c.status === 'open');
                  if (openChecks.length === 0) return "No open checklists.";

                  openChecks.slice(0, 3).forEach(c => { // List top 3 open lists
                      summary.push(`- ${c.title} (${c.items.length} items)`);
                  });

                  if (openChecks.length > 3) {
                      summary.push(`... and ${openChecks.length - 3} more open lists.`);
                  }

                  return summary.join('\n');
              }

              // Helper 3: Budget (Overview/Cost per day)
              function buildBudgetSummary() {
                  let summary = [];
                  if (appData.budget.length === 0) return "No active budgets to track.";

                  appData.budget.forEach(b => {
                      const days = daysBetween(b.startDate, b.endDate);
                      const costPerDay = calculateCostPerDay(b.amount, b.startDate, b.endDate);
                      // Only show if budget is active
                      if (days > 0 && costPerDay > 0) {
                          summary.push(`- ${b.title}: ‚Çπ${costPerDay}/day for ${days} days`);
                      }
                  });
                  return summary.length > 0 ? summary.join('\n') : "No active budget overview available.";
              }


              function checkNotifications(){
                // 1. Check global browser permission first
                if(!(Notification && Notification.permission === 'granted')) {
                   console.log("Global notification permission not granted. Skipping custom checks.");
                   return;
                }

                const now=new Date();
                const notifTimes=[8,13,18]; // 8 AM, 1 PM, 6 PM IST
                const currentHour = now.getHours();

                // Only proceed if it is one of the scheduled hours
                const isNotificationTime = notifTimes.includes(currentHour);
                if (!isNotificationTime) return;

                // --- Start Building Composite Notification Body ---

                let notificationBody = "Home Screen Summary:\n\n";
                let shouldSendNotification = false; // Only send if at least one category is enabled

                // 1. REMINDERS Summary
                if (appData.notifReminders) {
                    notificationBody += "‚ö†Ô∏è REMINDERS (Due Today/Tomorrow):\n";
                    notificationBody += buildReminderSummary() + "\n\n";
                    shouldSendNotification = true;
                }

                // 2. CHECKLIST Summary
                if (appData.notifChecklist) {
                    notificationBody += "‚úí CHECKLIST (Open):\n";
                    notificationBody += buildChecklistSummary() + "\n\n";
                    shouldSendNotification = true;
                }

                // 3. BUDGET Summary
                if (appData.notifBudget) {
                    notificationBody += "üí∞ BUDGET Overview:\n";
                    notificationBody += buildBudgetSummary() + "\n\n";
                    shouldSendNotification = true;
                }

                // 4. NOTES: General sync reminder (only at 6 PM)
                if (appData.notifNotes && currentHour === 18) {
                    notificationBody += "üìù NOTES: Remember to review and backup your notes!";
                    shouldSendNotification = true;
                }

                // --- Send Single Comprehensive Notification ---

                if (shouldSendNotification) {
                    new Notification("Nothing Reminder - Home Overview", {
                        body: notificationBody,
                        icon: 'assets/icon.png',
                        // Use requireInteraction for a non-dismissible-like notification
                        requireInteraction: true
                    });
                }
              }

      // ---------- Calculation History Functions ----------
              function renderHistory() {
                const list = byId('calculationHistoryList');
                list.innerHTML = '';
                if (appData.calculationHistory.length === 0) {
                  const li = document.createElement('li');
                  li.textContent = 'No calculation history yet.';
                  li.style.opacity = '0.7';
                  list.appendChild(li);
                  return;
                }

                const frag = document.createDocumentFragment();
                appData.calculationHistory.forEach((item, i) => {
                  const li = document.createElement('li');
                  const left = document.createElement('div');
                  left.className = 'item-left';

                  const title = document.createElement('div');
                  title.innerHTML = `<b>${item.title}</b>`;
                  title.style.fontWeight = '600';

                  const details = document.createElement('div');
                  details.style.fontSize = '13px';
                  details.style.opacity = '0.85';
                  details.textContent = `${item.result} | ${item.createdAt}`;

                  left.appendChild(title);
                  left.appendChild(details);

                  const right = document.createElement('div');
                  right.style.display = 'flex';
                  right.style.alignItems = 'center';

                  const editBtn = document.createElement('button');
                  editBtn.className = 'icon-small';
                  editBtn.textContent = '‚úèÔ∏è';
                  editBtn.title = 'Edit Title';
                  editBtn.addEventListener('click', () => editHistory(i));

                  const delBtn = document.createElement('button');
                  delBtn.className = 'icon-small';
                  delBtn.textContent = 'üóëÔ∏è';
                  delBtn.title = 'Delete';
                  delBtn.addEventListener('click', () => deleteHistory(i));

                  right.appendChild(editBtn);
                  right.appendChild(delBtn);
                  li.appendChild(left);
                  li.appendChild(right);
                  frag.appendChild(li);
                });
                list.appendChild(frag);
              }

              function saveHistory(result) {
                const title = prompt('Enter a title for this calculation:', 'New Calculation');
                if (title) {
                  const historyObj = {
                    title: title,
                    result: result,
                    createdAt: formatDateDMYWithTime(new Date())
                  };
                  appData.calculationHistory.push(historyObj);
                  saveAll();
                  renderHistory();
                }
              }

              function editHistory(index) {
                const item = appData.calculationHistory[index];
                const newTitle = prompt('Edit title:', item.title);
                if (newTitle) {
                  item.title = newTitle;
                  saveAll();
                  renderHistory();
                }
              }

              function deleteHistory(index) {
                // No confirmation, as requested
                appData.calculationHistory.splice(index, 1);
                saveAll();
                renderHistory();
              }

              // ---------- Normal Calculator Logic ----------
              let currentExpression = '0';
              const normalDisplay = byId('normalDisplay');

              function updateNormalDisplay(value) {
                if (value === 'clear') {
                  currentExpression = '0';
                } else if (value === 'backspace') {
                  currentExpression = currentExpression.length > 1 ? currentExpression.slice(0, -1) : '0';
                } else if (value === 'equals') {
                  try {
                    // Safely evaluate the expression
                    // eslint-disable-next-line no-eval
                    const result = eval(currentExpression);
                    saveHistory(`${currentExpression} = ${result}`);
                    currentExpression = String(result);
                  } catch (e) {
                    currentExpression = 'Error';
                  }
                } else {
                  if (currentExpression === '0' && value !== '.') {
                    currentExpression = value;
                  } else {
                    currentExpression += value;
                  }
                }
                normalDisplay.value = currentExpression;
              }

              document.querySelectorAll('.normal-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                  updateNormalDisplay(btn.dataset.value);
                });
              });

              // ---------- Age Calculator Logic ----------
              function calculateAge() {
                const dobStr = byId('dobInput').value;
                const asOfStr = byId('asOfDateInput').value || new Date().toISOString().split('T')[0]; // Default to today
                const resultEl = byId('ageResult');

                if (!dobStr) {
                  resultEl.textContent = 'Please enter a date of birth.';
                  return;
                }

                const dob = new Date(dobStr);
                const asOf = new Date(asOfStr);

                let age_years = asOf.getFullYear() - dob.getFullYear();
                let age_months = asOf.getMonth() - dob.getMonth();
                let age_days = asOf.getDate() - dob.getDate();

                if (age_days < 0) {
                  age_months--;
                  age_days += new Date(asOf.getFullYear(), asOf.getMonth(), 0).getDate(); // Days in the previous month
                }
                if (age_months < 0) {
                  age_years--;
                  age_months += 12;
                }

                const result = `Age as of ${formatDMY(asOfStr)}: ${age_years} years, ${age_months} months, and ${age_days} days.`;
                resultEl.textContent = result;

                saveHistory(`Age Calculation: DOB ${formatDMY(dobStr)} vs ${formatDMY(asOfStr)}`, result);
              }

              // ---------- Date Difference Calculator Logic ----------
              function calculateDateDifference() {
                const startStr = byId('dateDiffStart').value;
                const endStr = byId('dateDiffEnd').value;
                const resultEl = byId('dateDiffResult');

                if (!startStr || !endStr) {
                  resultEl.textContent = 'Please enter both start and end dates.';
                  return;
                }

                const startDate = new Date(startStr);
                const endDate = new Date(endStr);
                const diffTime = Math.abs(endDate.getTime() - startDate.getTime());
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                const result = `Difference: ${diffDays} day(s).`;
                resultEl.textContent = result;

                saveHistory(`Date Difference: ${formatDMY(startStr)} to ${formatDMY(endStr)}`, result);
              }

              // ---------- Calculator Mode Switcher ----------
              function switchCalculatorMode() {
                const mode = byId('calculatorMode').value;
                document.querySelectorAll('.calculator-mode').forEach(el => el.classList.add('hidden'));

                if (mode === 'normal') {
                  byId('normalCalculator').classList.remove('hidden');
                } else if (mode === 'age') {
                  byId('ageCalculator').classList.remove('hidden');
                } else if (mode === 'date') {
                  byId('dateCalculator').classList.remove('hidden');
                }
                // Reset history index when mode changes
                editingHistoryIndex = null;
              }

              // ---------- Monthly Calendar Logic ----------
              function renderCalendar(month, year) {
                const today = new Date();
                const grid = byId('calendarGrid');
                const monthYearHeader = byId('currentMonthYear');
                grid.innerHTML = '<div>S</div><div>M</div><div>T</div><div>W</div><div>T</div><div>F</div><div>S</div>'; // Weekday headers

                const date = new Date(year, month);
                monthYearHeader.textContent = date.toLocaleString('default', { month: 'long', year: 'numeric' });

                const firstDayOfMonth = new Date(year, month, 1).getDay(); // 0 for Sunday, 1 for Monday, etc.
                const daysInMonth = new Date(year, month + 1, 0).getDate();

                // Add spacer days for the start of the month
                for (let i = 0; i < firstDayOfMonth; i++) {
                  const spacer = document.createElement('div');
                  spacer.className = 'calendar-day spacer';
                  grid.appendChild(spacer);
                }

                // Add days of the month
                for (let day = 1; day <= daysInMonth; day++) {
                  const dayEl = document.createElement('div');
                  dayEl.className = 'calendar-day';
                  dayEl.textContent = day;

                  // Highlight today
                  if (day === today.getDate() && month === today.getMonth() && year === today.getFullYear()) {
                    dayEl.classList.add('today');
                  }

                  grid.appendChild(dayEl);
                }
              }

              function changeMonth(delta) {
                  currentMonth += delta;
                  if (currentMonth > 11) {
                      currentMonth = 0;
                      currentYear++;
                  } else if (currentMonth < 0) {
                      currentMonth = 11;
                      currentYear--;
                  }
                  renderCalendar(currentMonth, currentYear);
              }


              // ---------- Event Listeners ----------

      // Utilities Listeners
              byId('monthlyCalendarToggle').addEventListener('click', function() {
                toggleCollapse(byId('monthlyCalendarContainer'), byId('monthlyCalendarToggle'));
                renderCalendar(currentMonth, currentYear); // Render on opening
              });
              byId('prevMonthBtn').addEventListener('click', () => changeMonth(-1));
              byId('nextMonthBtn').addEventListener('click', () => changeMonth(1));

              byId('calculatorToggle').addEventListener('click', function() {
                toggleCollapse(byId('calculatorContainer'), byId('calculatorToggle'));
              });
              byId('calculatorMode').addEventListener('change', switchCalculatorMode);

              byId('calculateAgeBtn').addEventListener('click', calculateAge);
              byId('calculateDateDiffBtn').addEventListener('click', calculateDateDifference);

              byId('viewHistoryToggle').addEventListener('click', function() {
                toggleCollapse(byId('calculationHistoryList'), byId('viewHistoryToggle'));
              });
              // ... all other listeners ...

              // Notification Page Listener
              byId('requestPermissionBtn').addEventListener('click', requestNotificationPermission);
              byId('toggleReminders').addEventListener('change', (e) => handleCustomNotifToggle('notifReminders', e));
              byId('toggleNotes').addEventListener('change', (e) => handleCustomNotifToggle('notifNotes', e));
              byId('toggleChecklist').addEventListener('change', (e) => handleCustomNotifToggle('notifChecklist', e));
              byId('toggleBudget').addEventListener('change', (e) => handleCustomNotifToggle('notifBudget', e));


              byId('showAddFormBtn').addEventListener('click', function() {
                toggleCollapse(byId('reminderFormContainer'), byId('showAddFormBtn'));
              });

              byId('cancelReminderBtn').addEventListener('click', function() {
                hideForm(byId('reminderFormContainer'));
                editingIndex=null;
                clearReminderForm();
              });

              byId('saveReminderBtn').addEventListener('click', saveReminder);
              byId('viewRemindersToggle').addEventListener('click', function() {
                toggleCollapse(byId('reminderList'), byId('viewRemindersToggle'));
              });

              // Notes Listeners
              byId('showAddNoteBtn').addEventListener('click', function() {
                byId('saveNoteBtn').textContent = 'Save'; // Ensure it says Save
                toggleCollapse(byId('noteFormContainer'), byId('showAddNoteBtn'));
              });

              byId('cancelNoteBtn').addEventListener('click', function() {
                hideForm(byId('noteFormContainer'));
                editingNoteIndex = null;
                byId('saveNoteBtn').textContent = 'Save';
              });

              byId('saveNoteBtn').addEventListener('click', saveNote);

              byId('viewNotesToggle').addEventListener('click', function() {
                toggleCollapse(byId('noteList'), byId('viewNotesToggle'));
              });

              byId('homeRemindersToggle').addEventListener('click', function() {
                toggleCollapse(byId('homeRemindersContainer'), byId('homeRemindersToggle'));
              });

              byId('homeNotesToggle').addEventListener('click', function() {
                toggleCollapse(byId('homeNotesContainer'), byId('homeNotesToggle'));
              });

              byId('homeCheckToggle').addEventListener('click', function() {
                toggleCollapse(byId('homeCheckContainer'), byId('homeCheckToggle'));
              });

              byId('showAddBudgetBtn').addEventListener('click', function() {
                toggleCollapse(byId('budgetFormContainer'), byId('showAddBudgetBtn'));
              });

              byId('cancelBudgetBtn').addEventListener('click', function() {
                hideForm(byId('budgetFormContainer'));
                editingBudgetIndex=null;
                clearBudgetForm();
              });

              byId('saveBudgetBtn').addEventListener('click', saveBudget);
              byId('viewbudgetToggle').addEventListener('click', function() {
                toggleCollapse(byId('budgetList'), byId('viewbudgetToggle'));
              });
              byId('homeBudgetsToggle').addEventListener('click', function() {
                toggleCollapse(byId('homeBudgetsContainer'), byId('homeBudgetsToggle'));
              });

              // Check List Event Listeners
              byId('showAddCheckBtn').addEventListener('click', function() {
                toggleCollapse(byId('checkFormContainer'), byId('showAddCheckBtn'));
              });

              byId('cancelCheckBtn').addEventListener('click', function() {
                hideForm(byId('checkFormContainer'));
                editingCheckIndex = null;
                byId('saveCheckBtn').textContent = 'Save';
              });



              byId('saveCheckBtn').addEventListener('click', saveCheck);

              byId('viewCheckToggle').addEventListener('click', function() {
                toggleCollapse(byId('checkList'), byId('viewCheckToggle'));
              });

              document.querySelectorAll('.menu-btn[data-page]').forEach(btn=>{
                btn.addEventListener('click',function() {
                  showPage(this.dataset.page);
                });
              });

              function toggleCollapse(el, btn){
                el.classList.toggle('visible');
                btn.classList.toggle('open');
              }

              // ---------- Initial Render Code ----------

              // 1. Set initial UI states from loaded data
              if (appData.darkMode === '1') document.body.classList.add('dark');
              if (appData.profileName) profileNameEl.textContent = appData.profileName;
              if (appData.profilePhoto) byId('profilePhoto').src = appData.profilePhoto;

              // 2. Initial synchronous render of all data
              renderReminders();
              renderNotes();
              renderBudgets();
              renderChecklists();
              renderHistory(); // NEW: Initial render for history

              // NEW: Initialize calculator mode
              switchCalculatorMode();
              // ... rest of the initial render code ...

              // 3. Setup notifications and periodic check
              if ("Notification" in window) {
                  updateBrowserPermissionUI();
                  checkNotifications();
                  // Start the periodic check for notifications (every 5 minutes)
                  setInterval(checkNotifications, 5 * 60 * 1000);
              }

              // ---------- End Initial Render Code ----------

            })();
    </script>
  </body>
</html>
