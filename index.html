<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Nothing Reminder</title>
    <link rel="icon" type="image/png" href="assets/icon.png" />
    <style>
      :root {
        --bg: #ffffff;
        --text: #000000;
        --muted: #666;
        --accent: #4CAF50;
      }
      * { box-sizing: border-box; }
      body {
        margin: 0;
        font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
        background: var(--bg);
        color: var(--text);
      }
      .sidebar {
        width: 220px;
        background: #666;
        color: #fff;
        position: fixed;
        height: 100%;
        left: 0;
        display: flex;
        flex-direction: column;
        padding: 12px;
        gap: 8px;
        transition: left 0.3s ease;
      }
      .profile {
        display:flex;
        align-items:center;
        gap:10px;
        margin-bottom:4px;
      }
      .menu-btn, .icon-btn, .add-btn {
        display:block;
        width:100%;
        padding:10px;
        border: none;
        background:#888;
        font-style: Italic;
        color:#fff;
        border-radius:6px;
        cursor:pointer;
        text-align:left;
        font-size:15px;
        transition: background 0.2s;
      }
      .menu-btn:hover, .icon-btn:hover, .add-btn:hover { background:#aaa; }
      .main {
        margin-left: 220px;
        padding: 20px;
        min-height: 100vh;
        transition: margin-left 0.3s ease;
      }
      .page.hidden { display:none; }
      .toggle-btn {
        position: absolute;
        left: 210px;
        top: 12px;
        padding:6px 8px;
        border-radius:6px;
        border:none;
        background:#ddd;
        cursor:pointer;
        transition: left 0.3s ease;
        z-index: 10;
        width: 20px;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .list { list-style:none; padding:0; margin:0 0 12px 0; }
      .list li {
        display:flex;
        align-items:center;
        justify-content:space-between;
        padding:8px;
        border-radius:6px;
        margin-bottom:8px;
        background: rgba(0,0,0,0.03);
      }
      .item-left { display:flex; flex-direction:column; gap:4px; }
      .badge { background:#eee; padding:4px 8px; border-radius:12px; font-size:12px; }
      .form {
        margin-top: 0;
        padding: 12px;
        border-radius: 8px;
        background: #f5f5f5;
        display: flex;
        flex-direction: column;
        gap: 8px;
        max-width: 520px;
        overflow: hidden;
        transition: max-height 0.3s ease, padding 0.3s ease;
        max-height: 0;
        padding-top: 0;
        padding-bottom: 0;
      }
      .form.visible {
        max-height: 500px;
        padding-top: 12px;
        padding-bottom: 12px;
      }
      .form label {
        display:flex;
        flex-direction:column;
        font-size:13px;
        gap:6px;
      }
      .form input[type="text"], .form input[type="date"], .form textarea, .form select {
        padding:8px;
        border-radius:6px;
        border:1px solid #ccc;
      }
      .form-actions {
        display:flex;
        gap:8px;
        margin-top:6px;
      }
      .primary {
        background: var(--accent);
        color: #fff;
        border:none;
        padding:8px 12px;
        border-radius:6px;
        cursor:pointer;
      }
      .secondary {
        background:#ddd;
        border:none;
        padding:8px 12px;
        border-radius:6px;
        cursor:pointer;
      }
      .icon-small {
        background:transparent;
        border:none;
        cursor:pointer;
        margin-left:8px;
        font-size:16px;
      }
      .add-area {
        margin-top: 8px;
        max-width: 520px;
      }
      .dark {
        --bg: #121212;
        --text: #f1f1f1;
      }
      .dark .main { background:#151515; color:var(--text); }
      .dark .form { background: #232323; }
      .dark .menu-btn, .dark .icon-btn { background:#333; color:var(--text); }

      /* Settings panel styles */
      .settings-panel {
        display: none;
        flex-direction: column;
        gap: 8px;
        margin-top: 8px;
      }
      .settings-panel.visible { display: flex; }

      /* Consistent button styling for all sections */
      #showAddFormBtn, #homeRemindersToggle, #showAddNoteBtn, #viewNotesToggle, #homeNotesToggle,
      #homeBudgetsToggle, #homeCheckToggle, #showAddBudgetBtn, #viewbudgetToggle, #showAddCheckBtn,
      #viewCheckToggle {
        position: relative;
        user-select: none;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-weight: 600;
        font-size: 16px;
        cursor: pointer;
        padding: 10px;
        border: none;
        background: #888;
        color: #fff;
        border-radius: 6px;
        text-align: left;
      }

      #showAddFormBtn:hover, #homeRemindersToggle:hover, #showAddNoteBtn:hover, #viewNotesToggle:hover,
      #homeNotesToggle:hover, #homeBudgetsToggle:hover, #homeCheckToggle:hover, #showAddBudgetBtn:hover,
      #viewbudgetToggle:hover, #showAddCheckBtn:hover, #viewCheckToggle:hover {
        background: #aaa;
      }
      
      .arrow {
        transition: transform 0.3s ease;
      }

      #showAddFormBtn.open .arrow, #homeRemindersToggle.open .arrow, #showAddNoteBtn.open .arrow,
      #viewNotesToggle.open .arrow, #homeNotesToggle.open .arrow, #homeBudgetsToggle.open .arrow,
      #homeCheckToggle.open .arrow, #showAddBudgetBtn.open .arrow, #viewbudgetToggle.open .arrow,
      #showAddCheckBtn.open .arrow, #viewCheckToggle.open .arrow {
        transform: rotate(180deg);
      }

      /* Scrollable lists */
      .scrollable-list {
        max-height: 300px;
        overflow-y: auto;
        border: 1px solid #ccc;
        border-radius: 6px;
        padding: 8px;
        margin-top: 8px;
      }

      /* Scrollbar styling */
      .scrollable-list::-webkit-scrollbar {
        width: 8px;
        border-radius: 4px;
      }

      .scrollable-list::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 4px;
      }

      .scrollable-list::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 4px;
      }

      .scrollable-list::-webkit-scrollbar-thumb:hover {
        background: #555;
        border-radius: 4px;
      }

      /* Checklist status button */
      .status-btn {
        background: #007bff;
        color: white;
        border: none;
        padding: 4px 8px;
        border-radius: 4px;
        cursor: pointer;
        margin-right: 8px;
        font-size: 12px;
      }

      /* Branding footer */
      .branding-footer {
        position: fixed;
        bottom: 10px;
        left: 50%;
        transform: translateX(-50%);
        font-size: 12px;
        color: #666;
        text-align: center;
      }

      .branding-footer a {
        color: #666;
        text-decoration: none;
      }

      /* Notification Page Specific Styles */
      .notif-status-box {
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
        background: #e0f7fa;
        border: 1px solid #b2ebf2;
      }
      .notif-status-box.denied {
        background: #ffebee;
        border: 1px solid #ffcdd2;
      }
      .notif-setting-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 0;
        border-bottom: 1px solid #eee;
      }
      .notif-setting-item:last-child {
        border-bottom: none;
      }
      .toggle-switch {
        position: relative;
        display: inline-block;
        width: 50px;
        height: 24px;
      }
      .toggle-switch input {
        opacity: 0;
        width: 0;
        height: 0;
      }
      .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #ccc;
        transition: 0.4s;
        border-radius: 24px;
      }
      .slider:before {
        position: absolute;
        content: "";
        height: 16px;
        width: 16px;
        left: 4px;
        bottom: 4px;
        background-color: white;
        transition: 0.4s;
        border-radius: 50%;
      }
      input:checked + .slider {
        background-color: var(--accent);
      }
      input:checked + .slider:before {
        transform: translateX(26px);
      }
    </style>
  </head>
  <body>
    <div id="sidebar" class="sidebar">
      <div class="profile">
        <img
          id="profilePhoto"
          src="https://via.placeholder.com/40"
          alt="Profile"
          width="40"
          height="40"
          style="border-radius:50%;object-fit:cover;cursor:pointer;"
          onclick="document.getElementById('photoUpload').click()"
        />
        <h3 id="profileName">üë§ User</h3>
      </div>
      <input
        id="photoUpload"
        type="file"
        accept="image/*"
        style="display:none;"
      />
      
      <button class="menu-btn" data-page="home">üè† Home</button>
      <button class="menu-btn" data-page="reminders">‚è∞ Reminders</button>
      <button class="menu-btn" data-page="notes">üìù Notes</button>
      <button class="menu-btn" data-page="budget">üí∞ Budget Tracker</button>
      <button class="menu-btn" data-page="Check">‚úí Check List</button>
      <button class="menu-btn" data-page="other">üé≤ Other Apps</button>

      <div id="settingsContainer" style="margin-top:auto;">
        <button id="settingsBtn" class="icon-btn" aria-expanded="false">
          ‚öôÔ∏è Settings ‚ñº
        </button>
        <div id="settingsPanel" class="settings-panel" aria-hidden="true">
          <button class="menu-btn" id="editNameBtn">‚úèÔ∏è Edit Name</button>
          <button class="icon-btn" id="darkModeBtn">üåô Dark Mode</button>
          
          <button class="menu-btn" data-page="notifications" id="notificationBtn">
            üîî Notification Settings
          </button>
          
          <button class="menu-btn" data-page="terms">
            üí¢ Terms & Conditions
          </button>
          <button class="menu-btn" data-page="how">üßë‚Äçüè´ How to Use</button>
        </div>
      </div>
    </div>

    <div id="main" class="main">
      <button id="toggleBtn" class="toggle-btn">‚Æû</button>

      <div id="home" class="page">
        <h2>Home</h2>
        <div class="add-area">
          <button
            id="homeRemindersToggle"
            class="add-btn"
            aria-expanded="false"
          >
            ‚ö†Ô∏è Reminders <span class="arrow">‚ñº</span>
          </button>
          <div
            id="homeRemindersContainer"
            class="form"
            aria-hidden="true"
          ></div>
        </div>
        <div class="add-area">
          <button id="homeNotesToggle" class="add-btn" aria-expanded="false">
            üìù Notes <span class="arrow">‚ñº</span>
          </button>
          <div id="homeNotesContainer" class="form" aria-hidden="true"></div>
        </div>
        <div class="add-area">
          <button id="homeBudgetsToggle" class="add-btn" aria-expanded="false">
            üí∞ Budget Overview <span class="arrow">‚ñº</span>
          </button>
          <div id="homeBudgetsContainer" class="form" aria-hidden="true"></div>
        </div>

        <div class="add-area">
          <button id="homeCheckToggle" class="add-btn" aria-expanded="false">
            ‚úí Check List <span class="arrow">‚ñº</span>
          </button>
          <div id="homeCheckContainer" class="form" aria-hidden="true"></div>
        </div>

        <div class="branding-footer">
          <a href="https://github.com/spydernet3" target="_blank"
            >By Spydernet</a
          >
        </div>
      </div>

      <div id="reminders" class="page hidden">
        <h2>Reminders</h2>
        <div class="add-area">
          <button id="showAddFormBtn" class="add-btn" aria-expanded="false">
            Ôºã Add New Reminder <span class="arrow">‚ñº</span>
          </button>
          <div id="reminderFormContainer" class="form" aria-hidden="true">
            <label
              >Title<input id="reminderTitle" type="text" placeholder="Title"
            /></label>
            <label>Start date<input id="startDate" type="date" /></label>
            <label>End date<input id="endDate" type="date" /></label>
            <div class="form-actions">
              <button id="saveReminderBtn" class="primary">Save</button>
              <button id="cancelReminderBtn" class="secondary">Cancel</button>
            </div>
          </div>
        </div>
        <div class="add-area">
          <button
            id="viewRemindersToggle"
            class="add-btn"
            aria-expanded="false"
          >
            üëÄ View Reminders <span class="arrow">‚ñº</span>
          </button>
          <ul
            id="reminderList"
            class="list scrollable-list form"
            aria-hidden="true"
          ></ul>
        </div>
      </div>

      <div id="notes" class="page hidden">
        <h2>üìù Notes</h2>
        <div class="add-area">
          <button id="showAddNoteBtn" class="add-btn" aria-expanded="false">
            Ôºã Add New Note <span class="arrow">‚ñº</span>
          </button>
          <div id="noteFormContainer" class="form" aria-hidden="true">
            <label>
              Attach File
              <input
                id="noteFile"
                type="file"
                accept="image/*,.pdf,.doc,.docx,.mp3,.mp4"
              />
            </label>

            <label>
              Note<textarea
                id="noteText"
                rows="4"
                placeholder="Write your note here... (use | to separate columns and --- to separate rows)"
              ></textarea>
            </label>

            <label>
              Table Format<input type="checkbox" id="tableFormatCheckbox" />
              <span>Enable table format</span>
            </label>

            <div class="form-actions">
              <button id="saveNoteBtn" class="primary">Save</button>
              <button id="cancelNoteBtn" class="secondary">Cancel</button>
            </div>
          </div>
        </div>
        <div class="add-area">
          <button id="viewNotesToggle" class="add-btn" aria-expanded="false">
            üëÄ View Notes <span class="arrow">‚ñº</span>
          </button>
          <ul
            id="noteList"
            class="list scrollable-list form"
            aria-hidden="true"
          ></ul>
        </div>
      </div>

      <div id="budget" class="page hidden">
        <h2>üí∞ Budget Tracker</h2>
        <div class="add-area">
          <button id="showAddBudgetBtn" class="add-btn" aria-expanded="false">
            Ôºã Create New Budget <span class="arrow">‚ñº</span>
          </button>
          <div id="budgetFormContainer" class="form" aria-hidden="true">
            <label
              >Title<input
                id="budgetTitle"
                type="text"
                placeholder="Budget title"
            /></label>
            <label
              >Total Amount (‚Çπ)<input
                id="budgetAmount"
                type="number"
                placeholder="Total Amount"
            /></label>
            <label>Start Date<input id="budgetStartDate" type="date" /></label>
            <label>End Date<input id="budgetEndDate" type="date" /></label>
            <div class="form-actions">
              <button id="saveBudgetBtn" class="primary">Save</button>
              <button id="cancelBudgetBtn" class="secondary">Cancel</button>
            </div>
          </div>
        </div>
        <div class="add-area">
          <button id="viewbudgetToggle" class="add-btn" aria-expanded="false">
            üëÄ View Budget Overview <span class="arrow">‚ñº</span>
          </button>
          <ul
            id="budgetList"
            class="list scrollable-list form"
            aria-hidden="true"
          ></ul>
        </div>
      </div>

      <div id="Check" class="page hidden">
        <h2>‚úí Check List</h2>
        <div class="add-area">
          <button id="showAddCheckBtn" class="add-btn" aria-expanded="false">
            Ôºã Create New Checklist <span class="arrow">‚ñº</span>
          </button>
          <div id="checkFormContainer" class="form" aria-hidden="true">
            <label>
              Title<input
                id="checkTitle"
                type="text"
                placeholder="Checklist title"
              />
            </label>
            <label>
              Status<select id="checkStatus">
                <option value="open">Open</option>
                <option value="closed">Closed</option>
              </select>
            </label>
            <label>
              Items (one per line)<textarea
                id="checkItems"
                rows="4"
                placeholder="Item 1&#10;Item 2&#10;Item 3"
              ></textarea>
            </label>
            <div class="form-actions">
              <button id="saveCheckBtn" class="primary">Save</button>
              <button id="cancelCheckBtn" class="secondary">Cancel</button>
            </div>
          </div>
        </div>
        <div class="add-area">
          <button id="viewCheckToggle" class="add-btn" aria-expanded="false">
            üëÄ View Checklists <span class="arrow">‚ñº</span>
          </button>
          <ul
            id="checkList"
            class="list scrollable-list form"
            aria-hidden="true"
          ></ul>
        </div>
      </div>

      <div id="notifications" class="page hidden">
        <h2>üîî Notification Settings</h2>
        
        <div id="globalNotifStatus" class="notif-status-box">
          <h3>Browser Permission</h3>
          <p id="browserPermissionText"></p>
          <button id="requestPermissionBtn" class="primary" style="margin-top: 10px;">
            Request / Check Permission
          </button>
        </div>

        <h3>Notification Categories</h3>
        <p style="font-size: 14px; opacity: 0.8;">
          Note: Category notifications only work if the browser permission above is # Granted #.
        </p>

        <div class="notif-setting-item">
          <span>‚è∞ Reminder Page Reminders</span>
          <label class="toggle-switch">
            <input type="checkbox" id="toggleReminders" />
            <span class="slider"></span>
          </label>
        </div>

        <div class="notif-setting-item">
          <span>üìù Notes Reminders </span>
          <label class="toggle-switch">
            <input type="checkbox" id="toggleNotes" />
            <span class="slider"></span>
          </label>
        </div>

        <div class="notif-setting-item">
          <span>‚úí Checklist Reminders</span>
          <label class="toggle-switch">
            <input type="checkbox" id="toggleChecklist" />
            <span class="slider"></span>
          </label>
        </div>

        <div class="notif-setting-item">
          <span>üí∞ Budget Reminders</span>
          <label class="toggle-switch">
            <input type="checkbox" id="toggleBudget" />
            <span class="slider"></span>
          </label>
        </div>
      </div>


      <div id="terms" class="page hidden">
        <h1>Privacy Policy!</h1>
        <ul>
          <p>
            App data are stored using local storage. Avoid data losses before
            formatting the device.
          </p>
          <p>
            Maximum 500MB allowed to store datas in local storage.
          </p>
          <p>
            For the security reasons not allowed import and export datas and sharing datas to others
          </p>
          <p>
            If you'd like to contribute, check out here:
            <a href="https://github.com/spydernet3" target="_blank"
              >Spydernet Github ‚Ü†</a>
          </p>
        </ul>
        <hr />
        <h3>Version Info!</h3>
        <ul>
          <p>Version 13.4</p>
          <p>Last Updated: 14-Sep-2025</p>
          <p>Project: Open source project</p>
        </ul>
      </div>

      <div id="how" class="page hidden">
        <h3>Reminder!</h3>
        <hr />
        <ul>
          <li>Go to the Reminders page</li>
          <li>Click + Add New Reminder</li>
          <li>Fill Title, Start Date, End Date</li>
          <li>Click Save</li>
          <li>Edit or delete using the ‚úèÔ∏è and üóëÔ∏è button.</li>
          <li>Urgent reminders appear on the Home page automatically.</li>
        </ul>

        <h3>Notes!</h3>
        <hr />
        <ul>
          <li>Go to the Notes page.</li>
          <li>Click + Add New Note.</li>
          <li>Write your note in the textarea.</li>
          <li> It supports are kind of file formats(Images,pdf,audio,view,docs)
          <li>Click Save. IST date & time is added automatically.</li>
          <li>View notes in the collapsible View Notes section.</li>
          <li>Delete notes with üóëÔ∏è button.</li>
        </ul>

        <h3>Budget Tracker!</h3>
        <hr />
        <ul>
          <li>Go to the Budget Tracker page.</li>
          <li>Click + Add New Budget.</li>
          <li>That will showed Total Amount/Remaining Days</li>
          <li>That will shows Cost per day How much you need to spend</li>
        </ul>

        <h3>Profile!</h3>
        <hr />
        <ul>
          <li>Click the profile picture to upload a new image.</li>
          <li>Click Edit Name to update the username now under Settings.</li>
        </ul>
        <h3>Checklist!</h3>
        <hr />
        <ul>
          <li>Create checklist and set status either Open/Closed</li>
          <li>Opened checklist listed in Home screen</li>
        </ul>
        <h3>Dark Mode!</h3>
        <hr />
        <ul>
          <li>
            Open Settings (‚öôÔ∏è) in the sidebar, then click the üåô button to
            toggle dark mode.
          </li>
          <li>Dark mode preference is saved.</li>
        </ul>
        <h3>Notification!</h3>
        <hr />
        <ul>
          <li>Notification will showed 3 times in a day</li>
          <li>You will Turn Notification On/Off</li>
          <li>Morning 08:00 AM & Afternoon 01:00 PM & Evening 06:00 PM</li>
          <li> You can customize notification as per your requirements</li>
        </ul>
      </div>
    
    <div id="other" class="page hidden">
      <h2>üé≤ Other Apps</h2>
        <div style="display: flex; flex-wrap: wrap; gap: 20px; margin-top: 20px;">
          <a
            href="https://you-tube-seven.vercel.app/"
            target="_blank"
            style="text-decoration: none; color: inherit;"
          >
            <button class="menu-btn" style="width: 180px;">YouTube Filter</button>
          </a>
          <a
            href="https://spydernet3.github.io/QR-Generator/"
            target="_blank"
            style="text-decoration: none; color: inherit;"
          >
            <button class="menu-btn" style="width: 180px;">QR Generator</button>
          </a>
          <a
            href="https://spydernet3.github.io/multi_website_browser/"
            target="_blank"
            style="text-decoration: none; color: inherit;"
          >
            <button class="menu-btn" style="width: 180px;">Multi Website Browser</button>
          </a>
          <a
            href="https://spydernet3.github.io/Battery_Health_Monitor/"
            target="_blank"
            style="text-decoration: none; color: inherit;"
          >
            <button class="menu-btn" style="width: 180px;">Battery Health Monitor</button>
          </a>
          <a
            href="https://spydernet3.github.io/farewell/"
            target="_blank"
            style="text-decoration: none; color: inherit;"
          >
            <button class="menu-btn" style="width: 180px;">Farewell Wishes</button>
          </a>
          <a
            href="https://spydernet3.github.io/live-audio-transcrib/"
            target="_blank"
            style="text-decoration: none; color: inherit;"
          >
            <button class="menu-btn" style="width: 180px;">Live Audio Transcrib</button>
          </a>
          <a
            href="https://spydernet3.github.io/Notepad/"
            target="_blank"
            style="text-decoration: none; color: inherit;"
          >
            <button class="menu-btn" style="width: 180px;">Notepad</button>
          </a>
        </div>
    </div>
    </div>
    
    <script>
      // Service Worker Registration - Fixed to prevent errors
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          // Only register if sw.js exists
          fetch('/sw.js')
            .then(response => {
              if (response.ok) {
                return navigator.serviceWorker.register('/sw.js')
                  .then((registration) => {
                    console.log('SW registered: ', registration);
                  })
                  .catch((error) => {
                    console.log('SW registration failed: ', error);
                  });
              }
            })
            .catch(error => {
              console.log('Service worker file not found, skipping registration');
            });
        });
      }

      (function () {
        // ---------- Storage ----------
        const STORAGE_KEY = 'smart_reminder_app_v1';
        
        const defaultData = {
          reminders: [],
          notes: [],
          profileName: '',
          profilePhoto: '',
          darkMode: '0',
          budget: [],
          checklists: [],
          // NEW: Notification preferences
          notifReminders: true,
          notifNotes: true,
          notifChecklist: true,
          notifBudget: true
        };
        
        // Load data synchronously so it's available for event handlers immediately
        let appData = JSON.parse(localStorage.getItem(STORAGE_KEY)) || defaultData;
        // Merge with defaults to ensure new notif keys are present on load
        appData = { ...defaultData, ...appData }; 


        let editingIndex = null;
        let editingBudgetIndex = null;
        let editingCheckIndex = null;
        let editingNoteIndex = null;

        // ---------- Helpers ----------
        function byId(id){ return document.getElementById(id); }
        
        async function saveAll() {
          try {
            const dataStr = JSON.stringify(appData);
            localStorage.setItem(STORAGE_KEY, dataStr);
            console.log("Data saved successfully to localStorage.");
            renderNotificationPage(); 
          } catch (err) {
            console.error("Save failed:", err);
            if (err.name === 'QuotaExceededError') {
              console.error("Storage is full. Please delete some data to make space.");
            }
          }
        }
        
        function daysLeft(endDateStr){
          if(!endDateStr) return null;
          const [y,m,d] = endDateStr.split('-').map(Number);
          const end = new Date(y,m-1,d);
          const now = new Date();
          const diffTime = end.setHours(0,0,0,0) - now.setHours(0,0,0,0);
          return Math.floor(diffTime / (1000*60*60*24));
        }

        function formatDMY(dateStr){
          if(!dateStr) return '';
          const [y,m,d] = dateStr.split('-');
          return `${d.toString().padStart(2,'0')}/${m.toString().padStart(2,'0')}/${y}`;
        }

        function formatDateDMYWithTime(date) {
          const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun',
                         'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
          const day = date.getDate().toString().padStart(2, '0');
          const month = months[date.getMonth()];
          const year = date.getFullYear();
          const istHours = date.getHours();
          const istMinutes = date.getMinutes().toString().padStart(2, '0');
          const ampm = istHours >= 12 ? 'PM' : 'AM';
          const displayHours = istHours % 12 || 12;

          return `${day}-${month}-${year} ${displayHours}:${istMinutes} ${ampm}`;
        }

        function daysBetween(startDateStr, endDateStr) {
          if (!startDateStr || !endDateStr) return 0;
          const [startY, startM, startD] = startDateStr.split('-').map(Number);
          const [endY, endM, endD] = endDateStr.split('-').map(Number);
          const start = new Date(startY, startM-1, startD);
          const end = new Date(endY, endM-1, endD);
          const diffTime = end.setHours(0,0,0,0) - start.setHours(0,0,0,0);
          return Math.floor(diffTime / (1000*60*60*24)) + 1;
        }

        function calculateCostPerDay(amount, startDate, endDate) {
          const days = daysBetween(startDate, endDate);
          if (days <= 0 || amount <= 0) return 0;
          return (amount / days).toFixed(2);
        }

        // ---------- Render Functions ----------
        
        function renderReminders(){
          const list = byId('reminderList'); list.innerHTML = '';
          if(appData.reminders.length === 0){
            const li = document.createElement('li'); li.textContent='No reminders yet.'; li.style.opacity='0.7'; list.appendChild(li);
          } else {
            const frag = document.createDocumentFragment();
            appData.reminders.forEach((r,i)=>{
              const li=document.createElement('li');
              const left=document.createElement('div'); left.className='item-left';
              const title=document.createElement('div'); title.textContent=r.title; title.style.fontWeight='600';
              const dates=document.createElement('div'); dates.style.fontSize='13px'; dates.style.opacity='0.85'; dates.textContent=`Start: ${formatDMY(r.startDate)} | End: ${formatDMY(r.endDate)}`;
              left.appendChild(title); left.appendChild(dates);

              const right=document.createElement('div'); right.style.display='flex'; right.style.alignItems='center';
              const badge=document.createElement('div'); badge.className='badge';
              const diff = daysLeft(r.endDate);
              if(diff === null){ badge.textContent='No date'; }
              else if(diff < 0){ badge.textContent='Expired'; }
              else if(diff === 0){ badge.textContent='Today'; }
              else{ badge.textContent=`${diff} days left`; }

              const editBtn=document.createElement('button'); editBtn.className='icon-small'; editBtn.textContent='‚úèÔ∏è'; editBtn.title='Edit'; editBtn.addEventListener('click',()=>editReminder(i));
              const delBtn=document.createElement('button'); delBtn.className='icon-small'; delBtn.textContent='üóëÔ∏è'; delBtn.title='Delete'; delBtn.addEventListener('click',()=>deleteReminder(i));

              right.appendChild(badge);
              right.appendChild(editBtn);
              right.appendChild(delBtn);
              li.appendChild(left); li.appendChild(right); frag.appendChild(li);
            });
            list.appendChild(frag);
          }
          renderHomeReminders();
        }

        function renderHomeReminders(){
          const container = byId('homeRemindersContainer');
          container.innerHTML='';
          const filteredReminders = appData.reminders.filter(r => {
            const diff = daysLeft(r.endDate);
            return diff === 0 || diff === 1;
          });

          if(filteredReminders.length === 0){
            const li=document.createElement('li');
            li.textContent='No reminders for today or tomorrow.';
            li.style.opacity='0.7';
            container.appendChild(li);
            return;
          }

          const frag=document.createDocumentFragment();
          filteredReminders.forEach(r=>{
            const li=document.createElement('li');
            const diff = daysLeft(r.endDate);
            let badgeText = diff === 0 ? 'Today' : `${diff} days left`;
            li.textContent = `\"${r.title}\" || ${badgeText}`;
            frag.appendChild(li);
          });
          container.appendChild(frag);
        }

        function renderHomeNotes(){
          const container = byId('homeNotesContainer');
          container.innerHTML = '';

          if(appData.notes.length === 0){
            const li = document.createElement('li');
            li.textContent = 'No notes available.';
            li.style.opacity = '0.7';
            container.appendChild(li);
            return;
          }

          const frag = document.createDocumentFragment();
          appData.notes.forEach(n => {
            const li = document.createElement('li');
            li.className = 'list-item';
            const left = document.createElement('div');
            left.className = 'item-left';

            if(n.isTable && n.text) {
              const lines = n.text.split('\n');
              let tableHTML = '<table border=\"1\" style=\"border-collapse: collapse; width: 100%;\">';
              lines.forEach((line, index) => {
                if(line.includes('---')) {
                  if(index > 0) tableHTML += '</tr>';
                  tableHTML += '<tr>';
                } else if(line.includes('|')) {
                  const cells = line.split('|').filter(cell => cell.trim() !== '');
                  cells.forEach(cell => {
                    const cellContent = cell.trim();
                    tableHTML += index === 0 ? `<th style=\"border: 1px solid #ddd; padding: 4px;\">${cellContent}</th>` : `<td style=\"border: 1px solid #ddd; padding: 4px;\">${cellContent}</td>`;
                  });
                }
              });
              tableHTML += '</tr></table>';
              const text = document.createElement('div');
              text.innerHTML = tableHTML;
              left.appendChild(text);
            } else {
              const text = document.createElement('div');
              text.innerHTML = `<b>${n.text || ''}</b><br><small style=\"opacity:0.7\">${n.createdAt || ''}</small>`;
              left.appendChild(text);
            }

            if (n.file && n.file.type && n.file.type.includes('image')) {
              const thumb = document.createElement('img');
              thumb.src = n.file.data;
              thumb.style.cssText = 'max-width: 40px; margin-left: 5px; border-radius: 4px; vertical-align: middle;';
              thumb.alt = n.file.name || 'image';
              left.appendChild(thumb);
            }
            li.appendChild(left);
            frag.appendChild(li);
          });
          container.appendChild(frag);
        }

        function renderNotes(){
          const list = byId('noteList'); list.innerHTML='';
          if(appData.notes.length===0){
            const li=document.createElement('li');
            li.textContent='No notes yet.'; li.style.opacity='0.7';
            list.appendChild(li);
          } else {
            const frag=document.createDocumentFragment();
            appData.notes.forEach((note,i)=>{
              const li=document.createElement('li');
              const left=document.createElement('div'); left.className='item-left';

              const text=document.createElement('div');
              if(note.isTable && note.text) {
                const lines = note.text.split('\n');
                let tableHTML = '<table border=\"1\" style=\"border-collapse: collapse; width: 100%;\">';
                lines.forEach((line, index) => {
                  if(line.includes('---')) {
                    if(index > 0) tableHTML += '</tr>';
                    tableHTML += '<tr>';
                  } else if(line.includes('|')) {
                    const cells = line.split('|').filter(cell => cell.trim() !== '');
                    cells.forEach(cell => {
                      const cellContent = cell.trim();
                      tableHTML += index === 0 ? `<th style=\"border: 1px solid #ddd; padding: 8px;\">${cellContent}</th>` : `<td style=\"border: 1px solid #ddd; padding: 8px;\">${cellContent}</td>`;
                    });
                  }
                });
                tableHTML += '</tr></table>';
                text.innerHTML = tableHTML;
              } else {
                text.innerHTML=`<b>${note.text||''}</b><br><small style=\"opacity:0.7\">${note.createdAt||''}</small>`;
              }
              left.appendChild(text);

              if(note.file){
                let fileEl;
                if(note.file.type.includes('image')){
                  fileEl=document.createElement('img');
                  fileEl.src=note.file.data;
                  fileEl.style.cssText='max-width:200px; display:block; margin-top:5px;';
                } else if(note.file.type.includes('audio')){
                  fileEl=document.createElement('audio');
                  fileEl.controls=true;
                  fileEl.src=note.file.data;
                } else if(note.file.type.includes('video')){
                  fileEl=document.createElement('video');
                  fileEl.controls=true;
                  fileEl.width=200;
                  fileEl.src=note.file.data;
                } else {
                  fileEl=document.createElement('a');
                  fileEl.href=note.file.data;
                  fileEl.download=note.file.name;
                  fileEl.textContent='üìé '+note.file.name;
                }
                left.appendChild(fileEl);
              }

              const right = document.createElement('div'); right.style.display = 'flex'; right.style.alignItems = 'center';
              const editBtn = document.createElement('button'); editBtn.className = 'icon-small'; editBtn.textContent = '‚úèÔ∏è'; editBtn.title = 'Edit'; editBtn.addEventListener('click', () => editNote(i));
              const delBtn=document.createElement('button'); delBtn.className='icon-small'; delBtn.textContent='üóëÔ∏è'; delBtn.title='Delete'; delBtn.addEventListener('click',()=>{ deleteNote(i); });
              right.appendChild(editBtn); right.appendChild(delBtn);
              li.appendChild(left); li.appendChild(right); frag.appendChild(li);
            });
            list.appendChild(frag);
          }
          renderHomeNotes();
        }

        function renderBudgets(){
          const list = byId('budgetList'); list.innerHTML = '';
          if (!appData.budget || appData.budget.length === 0){
            const li = document.createElement('li'); li.textContent='No budgets yet.'; li.style.opacity='0.7'; list.appendChild(li);
          } else {
            const frag = document.createDocumentFragment();
            appData.budget.forEach((b,i)=>{
              const li=document.createElement('li');
              const left=document.createElement('div'); left.className='item-left';
              const costPerDay = calculateCostPerDay(b.amount, b.startDate, b.endDate);
              const days = daysBetween(b.startDate, b.endDate);
              const title=document.createElement('div'); title.textContent=`Title: ${b.title}`; title.style.fontWeight='600';
              const amounts=document.createElement('div'); amounts.style.fontSize='13px'; amounts.style.opacity='0.85'; amounts.textContent=`Total Budget: ‚Çπ${b.amount} | Remaining Days: ${days} | Cost per Day: ‚Çπ${costPerDay}`;
              left.appendChild(title); left.appendChild(amounts);
              const right=document.createElement('div'); right.style.display='flex'; right.style.alignItems='center';
              const editBtn=document.createElement('button'); editBtn.className='icon-small'; editBtn.textContent='‚úèÔ∏è'; editBtn.title='Edit'; editBtn.addEventListener('click',()=>editBudget(i));
              const delBtn=document.createElement('button'); delBtn.className='icon-small'; delBtn.textContent='üóëÔ∏è'; delBtn.title='Delete'; delBtn.addEventListener('click',()=>deleteBudget(i));
              right.appendChild(editBtn); right.appendChild(delBtn);
              li.appendChild(left); li.appendChild(right); frag.appendChild(li);
            });
            list.appendChild(frag);
          }
          renderHomeBudgets();
        }

        function renderHomeBudgets(){
          const container = byId('homeBudgetsContainer');
          container.innerHTML='';
          if (!appData.budget || appData.budget.length === 0){
            const li=document.createElement('li'); li.textContent='No budgets yet.'; li.style.opacity='0.7'; container.appendChild(li);
            return;
          }
          const frag=document.createDocumentFragment();
          appData.budget.forEach(b=>{
            const costPerDay = calculateCostPerDay(b.amount, b.startDate, b.endDate);
            const days = daysBetween(b.startDate, b.endDate);
            const li=document.createElement('li');
            li.textContent = `\"${b.title}\" || Total: ‚Çπ${b.amount} || Remaining: ${days} days || Cost: ‚Çπ${costPerDay}/day`;
            frag.appendChild(li);
          });
          container.appendChild(frag);
        }

        function renderChecklists(){
          const list = byId('checkList'); list.innerHTML = '';
          if (!appData.checklists || appData.checklists.length === 0){
            const li = document.createElement('li'); li.textContent='No checklists yet.'; li.style.opacity='0.7'; list.appendChild(li);
          } else {
            const frag = document.createDocumentFragment();
            appData.checklists.forEach((check,i)=>{
              const li=document.createElement('li');
              const left=document.createElement('div'); left.className='item-left';
              const title=document.createElement('div'); title.textContent=`${check.title}`; title.style.fontWeight='600';
              const itemsPreview=document.createElement('div'); itemsPreview.style.fontSize='13px'; itemsPreview.style.opacity='0.9';
              const previewItems = check.items.slice(0, 3);
              let itemsText = previewItems.map(item => `\u2022 ${item}`).join('<br>'); 
              if(check.items.length > 3) {
                  itemsText += '<br>... and ' + (check.items.length - 3) + ' more items';
              } else if (check.items.length === 0) {
                  itemsText = 'No items in list.';
              }
              itemsPreview.innerHTML = itemsText;
              const statusInfo=document.createElement('div'); statusInfo.style.fontSize='13px'; statusInfo.style.opacity='0.85'; statusInfo.textContent=`Status: ${check.status} | Total Items: ${check.items.length}`;
              const time=document.createElement('div'); time.style.fontSize='12px'; time.style.opacity='0.7'; time.textContent=check.createdAt || '';
              left.appendChild(title); left.appendChild(itemsPreview); left.appendChild(statusInfo); left.appendChild(time);
              const right = document.createElement('div'); right.style.display = 'flex'; right.style.alignItems = 'center';
              const statusBtn = document.createElement('button'); statusBtn.className = 'status-btn'; statusBtn.textContent = check.status === 'open' ? 'Open' : 'Closed'; statusBtn.title = 'Change Status'; statusBtn.addEventListener('click', () => toggleCheckStatus(i));
              const editBtn = document.createElement('button'); editBtn.className = 'icon-small'; editBtn.textContent = '‚úèÔ∏è'; editBtn.title = 'Edit'; editBtn.addEventListener('click', () => editCheck(i));
              const delBtn=document.createElement('button'); delBtn.className='icon-small'; delBtn.textContent='üóëÔ∏è'; delBtn.title='Delete'; delBtn.addEventListener('click',()=>{ deleteCheck(i); });
              right.appendChild(statusBtn); right.appendChild(editBtn); right.appendChild(delBtn);
              li.appendChild(left); li.appendChild(right); frag.appendChild(li);
            });
            list.appendChild(frag);
          }
          renderHomeCheck();
        }

        function renderHomeCheck(){
          const container = byId('homeCheckContainer');
          container.innerHTML = '';
          if (!appData.checklists || appData.checklists.length === 0){
            const li = document.createElement('li'); li.textContent = 'No checklists yet.'; li.style.opacity = '0.7'; container.appendChild(li);
            return;
          }
          const frag = document.createDocumentFragment();
          appData.checklists.forEach(check => {
            if(check.status === 'open') {
              const li = document.createElement('li');
              li.textContent = `\"${check.title}\" - ${check.items.length} items`;
              frag.appendChild(li);
            }
          });
          if(frag.children.length === 0) {
              const li = document.createElement('li'); li.textContent = 'No open checklists.'; li.style.opacity = '0.7'; container.appendChild(li);
          } else {
            container.appendChild(frag);
          }
        }
        
        // ---------- Action Functions (Save, Edit, Delete) ----------
        function editBudget(i){
          const b=appData.budget[i]; editingBudgetIndex=i;
          byId('budgetTitle').value=b.title; byId('budgetAmount').value=b.amount; byId('budgetStartDate').value=b.startDate||''; byId('budgetEndDate').value=b.endDate||'';
          showForm(byId('budgetFormContainer'));
        }

        function deleteBudget(index){
          appData.budget.splice(index, 1);
          saveAll(); renderBudgets();
        }

        function saveBudget(){
          const title=byId('budgetTitle').value.trim(), amount=byId('budgetAmount').value, start=byId('budgetStartDate').value, end=byId('budgetEndDate').value;
          if(!title || !amount){ console.error('Title and amount required'); return; }
          const budgetObj={ title, amount, startDate:start, endDate:end };
          if(editingBudgetIndex!==null){ appData.budget[editingBudgetIndex]=budgetObj; editingBudgetIndex=null; }
          else{ appData.budget.push(budgetObj); }
          saveAll(); renderBudgets(); hideForm(byId('budgetFormContainer')); clearBudgetForm();
        }

        function clearBudgetForm(){ byId('budgetTitle').value=''; byId('budgetAmount').value=''; byId('budgetStartDate').value=''; byId('budgetEndDate').value=''; }
        
        function editReminder(i){
          const r=appData.reminders[i]; editingIndex=i;
          byId('reminderTitle').value=r.title; byId('startDate').value=r.startDate||''; byId('endDate').value=r.endDate||'';
          showForm(byId('reminderFormContainer'));
        }

        function deleteReminder(index){
          appData.reminders.splice(index, 1);
          saveAll(); renderReminders();
        }

        function saveReminder(){
          const title=byId('reminderTitle').value.trim(), start=byId('startDate').value, end=byId('endDate').value;
          if(!title){ console.error('Title required'); return; }
          const reminderObj={ title, startDate:start, endDate:end };
          if(editingIndex!==null){ appData.reminders[editingIndex]=reminderObj; editingIndex=null; }
          else{ appData.reminders.push(reminderObj); }
          saveAll(); renderReminders(); hideForm(byId('reminderFormContainer')); clearReminderForm();
        }

        function clearReminderForm(){ byId('reminderTitle').value=''; byId('startDate').value=''; byId('endDate').value=''; }
        
        function deleteNote(index){
          appData.notes.splice(index,1);
          saveAll(); renderNotes();
        }

        function editNote(index){
          const note = appData.notes[index]; editingNoteIndex = index;
          byId('noteText').value = note.text || ''; byId('tableFormatCheckbox').checked = note.isTable || false;
          showForm(byId('noteFormContainer')); byId('saveNoteBtn').textContent = 'Update';
        }

        function saveNote(){
          const text = byId('noteText').value.trim(), fileInput = byId('noteFile'), file = fileInput.files[0], isTableFormat = byId('tableFormatCheckbox').checked;
          if(!text && !file){ console.error('Note cannot be empty'); return; }
          const noteDate = formatDateDMYWithTime(new Date());
          const noteObj = { text: isTableFormat && text ? `Created: ${noteDate}\n\n${text}` : text, createdAt: noteDate, file: null, isTable: isTableFormat };

          const processSave = (finalNoteObj) => {
            if(editingNoteIndex !== null){ appData.notes[editingNoteIndex] = finalNoteObj; editingNoteIndex = null; } 
            else { appData.notes.push(finalNoteObj); }
            saveAll(); renderNotes();
            hideForm(byId('noteFormContainer')); byId('noteText').value=''; fileInput.value=''; byId('tableFormatCheckbox').checked = false; byId('saveNoteBtn').textContent = 'Save';
          };

          if(file){
            const reader = new FileReader();
            reader.onload = function(e){
              noteObj.file = { name: file.name, type: file.type, data: e.target.result };
              processSave(noteObj);
            };
            reader.onerror = () => { console.error('Error reading file.'); fileInput.value = ''; };
            reader.readAsDataURL(file);
          } else {
            processSave(noteObj);
          }
        }
        
        function deleteCheck(index){
          appData.checklists.splice(index,1);
          saveAll(); renderChecklists();
        }

        function editCheck(index){
          const check = appData.checklists[index]; editingCheckIndex = index;
          byId('checkTitle').value = check.title || ''; byId('checkStatus').value = check.status || 'open'; byId('checkItems').value = check.items ? check.items.join('\n') : '';
          showForm(byId('checkFormContainer')); byId('saveCheckBtn').textContent = 'Update';
        }

        function toggleCheckStatus(index) {
          const check = appData.checklists[index];
          check.status = check.status === 'open' ? 'closed' : 'open';
          saveAll(); renderChecklists();
        }
        
        function saveCheck(){
          const title = byId('checkTitle').value.trim(), status = byId('checkStatus').value, itemsText = byId('checkItems').value.trim();
          if(!title){ console.error('Title required'); return; }
          const checkObj = { title, items: itemsText ? itemsText.split('\n').filter(item => item.trim() !== '') : [], status: status, createdAt: formatDateDMYWithTime(new Date()) };
          if(editingCheckIndex !== null){ appData.checklists[editingCheckIndex] = checkObj; editingCheckIndex = null; }
          else { appData.checklists.push(checkObj); }
          saveAll(); renderChecklists();
          hideForm(byId('checkFormContainer')); byId('checkTitle').value = ''; byId('checkStatus').value = 'open'; byId('checkItems').value = ''; byId('saveCheckBtn').textContent = 'Save';
        }

        // ---------- UI Interaction ----------
        function showForm(el){ el.classList.add('visible'); }
        function hideForm(el){ el.classList.remove('visible'); }

        const sidebar = byId('sidebar'), main = byId('main'), toggleBtn = byId('toggleBtn');

        function showPage(pageId){
          document.querySelectorAll('.page').forEach(p=>p.classList.add('hidden'));
          byId(pageId).classList.remove('hidden');
          if (pageId === 'notifications') renderNotificationPage();
          if (window.innerWidth < 768) { // Auto-hide on smaller screens
            sidebar.style.left = '-220px'; main.style.marginLeft = '0'; toggleBtn.textContent = '‚Æû';
          }
        }

        toggleBtn.addEventListener('click', function() {
          const isHidden = sidebar.style.left === '-220px' || sidebar.style.left === '';
          sidebar.style.left = isHidden ? '0px' : '-220px';
          main.style.marginLeft = isHidden ? '220px' : '0';
          toggleBtn.textContent = isHidden ? '‚Æú' : '‚Æû';
        });

        const settingsBtn = byId('settingsBtn'), settingsPanel = byId('settingsPanel');
        if(settingsBtn && settingsPanel){
          settingsBtn.addEventListener('click', ()=>{
            const opened = settingsPanel.classList.toggle('visible');
            settingsBtn.setAttribute('aria-expanded', opened);
            settingsPanel.setAttribute('aria-hidden', !opened);
          });
        }

        byId('darkModeBtn').addEventListener('click',()=>{
          document.body.classList.toggle('dark');
          appData.darkMode=document.body.classList.contains('dark')?'1':'0';
          saveAll();
        });

        byId('editNameBtn').addEventListener('click',()=>{
          const n=prompt('Enter new name:',appData.profileName||'');
          if(n){
            appData.profileName=n; byId('profileName').textContent=n; saveAll();
          }
        });

        byId('photoUpload').addEventListener('change',(e)=>{
          const file=e.target.files[0];
          if(file){
            const reader=new FileReader();
            reader.onload=function(ev){
              appData.profilePhoto=ev.target.result; byId('profilePhoto').src=ev.target.result; saveAll();
            };
            reader.readAsDataURL(file);
          }
        });

        // ---------- Notification Settings Logic ----------
        function updateBrowserPermissionUI() {
            if (!("Notification" in window)) return;
            const status = Notification.permission;
            const textEl = byId('browserPermissionText'), boxEl = byId('globalNotifStatus'), btnEl = byId('requestPermissionBtn');
            boxEl.classList.remove('denied');
            if (status === 'granted') { textEl.innerHTML = 'Status: <b style="color: var(--accent);">Granted (ON)</b>'; btnEl.textContent = 'Permission Granted'; btnEl.disabled = true; }
            else if (status === 'denied') { textEl.innerHTML = 'Status: <b style="color: #f44336;">Denied (OFF)</b>. Please change in browser settings.'; btnEl.textContent = 'Permission Denied'; btnEl.disabled = true; boxEl.classList.add('denied'); }
            else { textEl.innerHTML = 'Status: <b style="color: #ff9800;">Not Requested (OFF)</b>'; btnEl.textContent = 'Request Permission'; btnEl.disabled = false; }
        }

        function requestNotificationPermission() {
          if (!("Notification" in window)) { console.error("Browser does not support notifications"); return; }
          if (Notification.permission !== 'default') { updateBrowserPermissionUI(); return; }
          Notification.requestPermission().then(updateBrowserPermissionUI);
        }
        
        function renderNotificationPage() {
            if (!("Notification" in window)) { byId('globalNotifStatus').innerHTML = '<h3>Browser Permission</h3><p style="color: #f44336;">Notifications are not supported by your browser.</p>'; return; }
            updateBrowserPermissionUI();
            byId('toggleReminders').checked = appData.notifReminders; byId('toggleNotes').checked = appData.notifNotes; byId('toggleChecklist').checked = appData.notifChecklist; byId('toggleBudget').checked = appData.notifBudget;
        }

        function handleCustomNotifToggle(category, event) {
            appData[category] = event.target.checked;
            saveAll();
            if (event.target.checked) checkNotifications();
        }

        function checkNotifications(){
          if(!(Notification && Notification.permission === 'granted')) return;
          const now=new Date(), currentHour = now.getHours();
          if (![8,13,18].includes(currentHour)) return;
          if(appData.notifReminders) { appData.reminders.forEach(r=>{ const diff=daysLeft(r.endDate); if(diff<=1) new Notification("Reminder Alert!", { body: `${r.title} - ${diff<0?'Expired':diff===0?'Today':'1 day left'}`, icon:'assets/icon.png' }); }); }
          if(appData.notifChecklist) { const openChecks = appData.checklists.filter(c => c.status === 'open'); if (openChecks.length > 0) new Notification("Checklist Alert!", { body: `You have ${openChecks.length} open checklist(s).`, icon:'assets/icon.png' }); }
          if(appData.notifBudget) { appData.budget.forEach(b => { const days = daysBetween(b.startDate, b.endDate), costPerDay = calculateCostPerDay(b.amount, b.startDate, b.endDate); if (days > 0 && costPerDay > 0) new Notification("Budget Tracker", { body: `Budget: ${b.title}. Recommended spend today: ‚Çπ${costPerDay}. ${days} days remaining.`, icon:'assets/icon.png' }); }); }
          if(appData.notifNotes && currentHour === 18) new Notification("Notes Sync Reminder", { body: "Remember to review and backup your important notes!", icon:'assets/icon.png' });
        }

        // ---------- Event Listener Attachments ----------
        byId('requestPermissionBtn').addEventListener('click', requestNotificationPermission);
        byId('toggleReminders').addEventListener('change', (e) => handleCustomNotifToggle('notifReminders', e));
        byId('toggleNotes').addEventListener('change', (e) => handleCustomNotifToggle('notifNotes', e));
        byId('toggleChecklist').addEventListener('change', (e) => handleCustomNotifToggle('notifChecklist', e));
        byId('toggleBudget').addEventListener('change', (e) => handleCustomNotifToggle('notifBudget', e));
        byId('saveReminderBtn').addEventListener('click', saveReminder);
        byId('saveNoteBtn').addEventListener('click', saveNote);
        byId('saveBudgetBtn').addEventListener('click', saveBudget);
        byId('saveCheckBtn').addEventListener('click', saveCheck);
        byId('cancelReminderBtn').addEventListener('click', () => { hideForm(byId('reminderFormContainer')); editingIndex=null; clearReminderForm(); });
        byId('cancelNoteBtn').addEventListener('click', () => { hideForm(byId('noteFormContainer')); editingNoteIndex = null; byId('saveNoteBtn').textContent = 'Save'; });
        byId('cancelBudgetBtn').addEventListener('click', () => { hideForm(byId('budgetFormContainer')); editingBudgetIndex=null; clearBudgetForm(); });
        byId('cancelCheckBtn').addEventListener('click', () => { hideForm(byId('checkFormContainer')); editingCheckIndex = null; byId('saveCheckBtn').textContent = 'Save'; });
        document.querySelectorAll('.menu-btn[data-page]').forEach(btn => btn.addEventListener('click', function() { showPage(this.dataset.page); }));
        function toggleCollapse(el, btn){ el.classList.toggle('visible'); btn.classList.toggle('open'); }
        byId('showAddFormBtn').addEventListener('click', function() { toggleCollapse(byId('reminderFormContainer'), this); });
        byId('viewRemindersToggle').addEventListener('click', function() { toggleCollapse(byId('reminderList'), this); });
        byId('showAddNoteBtn').addEventListener('click', function() { toggleCollapse(byId('noteFormContainer'), this); });
        byId('viewNotesToggle').addEventListener('click', function() { toggleCollapse(byId('noteList'), this); });
        byId('showAddBudgetBtn').addEventListener('click', function() { toggleCollapse(byId('budgetFormContainer'), this); });
        byId('viewbudgetToggle').addEventListener('click', function() { toggleCollapse(byId('budgetList'), this); });
        byId('showAddCheckBtn').addEventListener('click', function() { toggleCollapse(byId('checkFormContainer'), this); });
        byId('viewCheckToggle').addEventListener('click', function() { toggleCollapse(byId('checkList'), this); });
        byId('homeRemindersToggle').addEventListener('click', function() { toggleCollapse(byId('homeRemindersContainer'), this); });
        byId('homeNotesToggle').addEventListener('click', function() { toggleCollapse(byId('homeNotesContainer'), this); });
        byId('homeBudgetsToggle').addEventListener('click', function() { toggleCollapse(byId('homeBudgetsContainer'), this); });
        byId('homeCheckToggle').addEventListener('click', function() { toggleCollapse(byId('homeCheckContainer'), this); });

        // ---------- FIX: Wait for page to be fully loaded before rendering data ----------
        window.addEventListener('load', () => {
            // Set initial UI states from loaded data
            if (appData.darkMode === '1') document.body.classList.add('dark');
            if (appData.profileName) byId('profileName').textContent = appData.profileName;
            if (appData.profilePhoto) byId('profilePhoto').src = appData.profilePhoto;

            // Initial render of all data
            renderReminders();
            renderNotes();
            renderBudgets();
            renderChecklists();
            
            // Setup notifications
            if ("Notification" in window) {
                updateBrowserPermissionUI();
            }
            checkNotifications();
            setInterval(checkNotifications, 5 * 60 * 1000); 
        });

      })();
    </script>
  </body>
</html>
